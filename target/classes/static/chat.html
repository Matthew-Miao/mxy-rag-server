<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能问答 - 智能问答系统</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <span>智能问答</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="username" id="current-username">用户</div>
                        <div class="user-menu">
                            <button class="btn btn-sm" id="user-menu-btn">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div class="dropdown-menu" id="user-dropdown">
                                <a href="#" id="change-password-btn">
                                    <i class="fas fa-key"></i>
                                    修改密码
                                </a>
                                <a href="knowledge.html">
                                    <i class="fas fa-database"></i>
                                    知识库管理
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="#" id="logout-btn">
                                    <i class="fas fa-sign-out-alt"></i>
                                    退出登录
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="new-chat-section">
                <button class="btn btn-primary btn-full" id="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    新建对话
                </button>
            </div>
            
            <div class="session-list">
                <div class="session-list-header">
                    <h3>对话历史</h3>
                    <button class="btn btn-sm" id="refresh-sessions-btn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="session-items" id="session-items">
                    <!-- 会话列表将在这里动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 主聊天区域 -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="session-title">
                    <h2 id="current-session-title">选择或创建一个对话</h2>
                    <button class="btn btn-sm" id="edit-title-btn" style="display: none;">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="chat-actions">
                    <button class="btn btn-sm" id="clear-chat-btn" style="display: none;">
                        <i class="fas fa-trash"></i>
                        清空对话
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3>欢迎使用智能问答系统</h3>
                    <p>基于RAG技术的智能问答平台，为您提供准确、及时的答案</p>
                    <div class="welcome-features">
                        <div class="feature">
                            <i class="fas fa-brain"></i>
                            <span>智能理解</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-database"></i>
                            <span>知识检索</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-comments"></i>
                            <span>流式对话</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="message-input" 
                            class="chat-textarea"
                            placeholder="输入您的问题..." 
                            rows="1"
                            maxlength="2000"
                        ></textarea>
                        <button class="send-btn" id="send-btn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-actions" style="display: none;">
                        <button class="btn btn-sm" id="stop-btn" style="display: none;">
                            <i class="fas fa-stop"></i>
                        </button>
                    </div>
                </div>
                <div class="input-footer">
                    <div class="char-count">
                        <span id="char-count">0</span>/2000
                    </div>
                    <div class="input-tips">
                        <span>按 Enter 发送，Shift+Enter 换行</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 修改密码对话框 -->
    <div id="change-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>修改密码</h3>
                <button class="modal-close" id="close-password-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="current-password">当前密码</label>
                        <div class="password-input">
                            <input type="password" id="current-password" name="oldPassword" required>
                            <button type="button" class="password-toggle" data-target="current-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="current-password-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">新密码</label>
                        <div class="password-input">
                            <input type="password" id="new-password" name="newPassword" required>
                            <button type="button" class="password-toggle" data-target="new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="new-password-error"></div>
                        <div class="help-text">密码至少8位，包含字母和数字</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-new-password">确认新密码</label>
                        <div class="password-input">
                            <input type="password" id="confirm-new-password" name="confirmPassword" required>
                            <button type="button" class="password-toggle" data-target="confirm-new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="confirm-new-password-error"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-password-btn">取消</button>
                <button class="btn btn-primary" id="save-password-btn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑标题对话框 -->
    <div id="edit-title-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑对话标题</h3>
                <button class="modal-close" id="close-title-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="session-title-input">对话标题</label>
                    <input type="text" id="session-title-input" maxlength="50" placeholder="请输入对话标题">
                    <div class="help-text">最多50个字符</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-title-btn">取消</button>
                <button class="btn btn-primary" id="save-title-btn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 加载提示 -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>处理中...</p>
        </div>
    </div>
    
    <!-- 消息提示 -->
    <div id="message-container" class="message-container"></div>
    
    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script>
        class ChatPage {
            constructor() {
                this.currentSession = null;
                this.editingSession = null; // 当前正在编辑的会话
                this.isTyping = false;
                this.init();
            }
            
            init() {
                // 检查登录状态
                PageGuard.setup({ requireAuth: true });
                
                this.setupEventListeners();
                this.setupChatEvents();
                this.loadUserInfo();
                this.loadSessions();
            }
            
            setupEventListeners() {
                // 新建对话
                document.getElementById('new-chat-btn').addEventListener('click', () => {
                    this.createNewChat();
                });
                
                // 刷新会话列表
                document.getElementById('refresh-sessions-btn').addEventListener('click', () => {
                    this.loadSessions();
                });
                
                // 发送消息
                document.getElementById('send-btn').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                // 停止生成
                document.getElementById('stop-btn').addEventListener('click', () => {
                    this.stopGeneration();
                });
                
                // 输入框事件
                const messageInput = document.getElementById('message-input');
                messageInput.addEventListener('input', () => {
                    this.handleInputChange();
                });
                
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // 自动调整输入框高度
                messageInput.addEventListener('input', () => {
                    this.adjustTextareaHeight(messageInput);
                });
                
                // 用户菜单
                document.getElementById('user-menu-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleUserMenu();
                });
                
                // 点击其他地方关闭菜单
                document.addEventListener('click', () => {
                    this.closeUserMenu();
                });
                
                // 修改密码
                document.getElementById('change-password-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showChangePasswordModal();
                });
                
                // 退出登录
                document.getElementById('logout-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });
                
                // 编辑标题
                document.getElementById('edit-title-btn').addEventListener('click', () => {
                    this.showEditTitleModal();
                });
                
                // 清空对话
                document.getElementById('clear-chat-btn').addEventListener('click', () => {
                    this.clearChat();
                });
                
                // 模态框事件
                this.setupModalEvents();
                
                // 密码显示/隐藏
                document.querySelectorAll('.password-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget.dataset.target;
                        const input = document.getElementById(target);
                        const icon = e.currentTarget.querySelector('i');
                        
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.className = 'fas fa-eye-slash';
                        } else {
                            input.type = 'password';
                            icon.className = 'fas fa-eye';
                        }
                    });
                });
            }
            
            setupChatEvents() {
                // 监听聊天事件
                chatManager.on('sessionsLoaded', (e) => {
                    console.log('收到sessionsLoaded事件:', e.detail.sessions);
                    this.renderSessions(e.detail.sessions);
                });
                
                chatManager.on('sessionCreated', (e) => {
                    this.switchToSession(e.detail.session);
                });
                
                chatManager.on('sessionChanged', (e) => {
                    this.switchToSession(e.detail.session);
                });
                
                chatManager.on('historyLoaded', (e) => {
                    this.renderMessages(e.detail.messages);
                });
                
                chatManager.on('messageAdded', (e) => {
                    this.addMessage(e.detail.message);
                });
                
                chatManager.on('messageUpdated', (e) => {
                    this.updateMessage(e.detail.message);
                });
                
                chatManager.on('streamComplete', (e) => {
                    this.onStreamComplete();
                });
            }
            
            setupModalEvents() {
                // 修改密码模态框
                document.getElementById('close-password-modal').addEventListener('click', () => {
                    this.hideChangePasswordModal();
                });
                
                document.getElementById('cancel-password-btn').addEventListener('click', () => {
                    this.hideChangePasswordModal();
                });
                
                document.getElementById('save-password-btn').addEventListener('click', () => {
                    this.handleChangePassword();
                });
                
                // 编辑标题模态框
                document.getElementById('close-title-modal').addEventListener('click', () => {
                    this.hideEditTitleModal();
                });
                
                document.getElementById('cancel-title-btn').addEventListener('click', () => {
                    this.hideEditTitleModal();
                });
                
                document.getElementById('save-title-btn').addEventListener('click', () => {
                    this.handleSaveTitle();
                });
            }
            
            loadUserInfo() {
                const user = authManager.getCurrentUser();
                if (user) {
                    document.getElementById('current-username').textContent = user.username || '用户';
                }
            }
            
            async loadSessions() {
                try {
                    await chatManager.loadSessions();
                } catch (error) {
                    Utils.showMessage('加载会话列表失败', 'error');
                }
            }
            
            renderSessions(sessions) {
                const container = document.getElementById('session-items');
                container.innerHTML = '';
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-sessions">
                            <i class="fas fa-comments"></i>
                            <p>暂无对话记录</p>
                        </div>
                    `;
                    return;
                }
                
                sessions.forEach(session => {
                    const item = this.createSessionItem(session);
                    container.appendChild(item);
                });
            }
            
            createSessionItem(session) {
                const item = document.createElement('div');
                item.className = 'session-item';
                item.dataset.sessionId = session.id;
                
                item.innerHTML = `
                    <div class="session-content">
                        <div class="session-title">${Utils.escapeHtml(session.title)}</div>
                        <div class="session-time">${Utils.formatTime(session.gmtModified || session.updateTime)}</div>
                    </div>
                    <div class="session-actions">
                        <button class="action-btn edit-session-btn" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-session-btn" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // 点击切换会话
                item.querySelector('.session-content').addEventListener('click', () => {
                    this.switchSession(session.id);
                });
                
                // 编辑会话
                item.querySelector('.edit-session-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.editSession(session);
                });
                
                // 删除会话
                item.querySelector('.delete-session-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('删除按钮被点击，会话:', session);
                    this.deleteSession(session);
                });
                
                return item;
            }
            
            /**
             * 创建新对话（带幂等性检查）
             * 如果当前已经是一个空的新对话，则不重复创建
             */
            async createNewChat() {
                try {
                    // 幂等性检查：如果当前会话存在且没有消息历史，则不需要创建新对话
                    if (this.currentSession && chatManager.messageHistory.length === 0) {
                        console.log('当前已经是新对话，无需重复创建');
                        return;
                    }
                    
                    const result = await chatManager.createSession();
                    if (result && result.success) {
                        // 同步当前会话状态
                        this.currentSession = result.session;
                        // 触发UI更新
                        this.switchToSession(result.session);
                    }
                } catch (error) {
                    Utils.showMessage('创建对话失败', 'error');
                    throw error;
                }
            }
            
            async switchSession(sessionId) {
                try {
                    await chatManager.switchSession(sessionId);
                } catch (error) {
                    Utils.showMessage('切换对话失败', 'error');
                }
            }
            
            switchToSession(session) {
                this.currentSession = session;
                
                // 更新UI
                document.getElementById('current-session-title').textContent = session.title;
                document.getElementById('edit-title-btn').style.display = 'inline-block';
                document.getElementById('clear-chat-btn').style.display = 'inline-block';
                
                // 更新会话列表选中状态
                document.querySelectorAll('.session-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.sessionId == session.id);
                });
                
                // 隐藏欢迎消息
                const welcomeMsg = document.querySelector('.welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.style.display = 'none';
                }
            }
            
            renderMessages(messages) {
                const container = document.getElementById('chat-messages');
                
                // 清除现有消息（保留欢迎消息）
                const existingMessages = container.querySelectorAll('.message');
                existingMessages.forEach(msg => msg.remove());
                
                // 渲染消息
                messages.forEach(message => {
                    const messageEl = MessageRenderer.renderMessage(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            addMessage(message) {
                const container = document.getElementById('chat-messages');
                const messageEl = MessageRenderer.renderMessage(message);
                container.appendChild(messageEl);
                this.scrollToBottom();
            }
            
            updateMessage(message) {
                const messageEl = document.querySelector(`[data-message-id="${message.id}"]`);
                if (messageEl) {
                    const newMessageEl = MessageRenderer.renderMessage(message);
                    messageEl.replaceWith(newMessageEl);
                    this.scrollToBottom();
                }
            }
            
            async sendMessage() {
                const input = document.getElementById('message-input');
                const message = input.value.trim();
                
                if (!message) {
                    return;
                }
                
                try {
                    // 如果没有当前会话，先创建一个新会话
                    if (!this.currentSession) {
                        await this.createNewChat();
                        // 确保会话创建成功
                        if (!this.currentSession) {
                            Utils.showMessage('创建对话失败，请重试', 'error');
                            return;
                        }
                    }
                    
                    // 清空输入框
                    input.value = '';
                    this.handleInputChange();
                    this.adjustTextareaHeight(input);
                    
                    // 更新UI状态
                    this.setTypingState(true);
                    
                    // 发送消息
                    await chatManager.sendMessage(message, true);
                    
                } catch (error) {
                    Utils.showMessage(error.message || '发送失败', 'error');
                    this.setTypingState(false);
                }
            }
            
            stopGeneration() {
                chatManager.stopStreaming();
                this.setTypingState(false);
            }
            
            onStreamComplete() {
                this.setTypingState(false);
            }
            
            setTypingState(isTyping) {
                this.isTyping = isTyping;
                
                const sendBtn = document.getElementById('send-btn');
                const stopBtn = document.getElementById('stop-btn');
                const input = document.getElementById('message-input');
                
                if (isTyping) {
                    sendBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    input.disabled = true;
                } else {
                    sendBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    input.disabled = false;
                    input.focus();
                }
            }
            
            handleInputChange() {
                const input = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                const charCount = document.getElementById('char-count');
                
                const length = input.value.length;
                charCount.textContent = length;
                
                sendBtn.disabled = length === 0 || this.isTyping;
            }
            
            adjustTextareaHeight(textarea) {
                textarea.style.height = 'auto';
                const maxHeight = 120; // 最大高度
                const newHeight = Math.min(textarea.scrollHeight, maxHeight);
                textarea.style.height = newHeight + 'px';
            }
            
            scrollToBottom() {
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight;
            }
            
            toggleUserMenu() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.toggle('show');
            }
            
            closeUserMenu() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.remove('show');
            }
            
            showChangePasswordModal() {
                document.getElementById('change-password-modal').classList.remove('hidden');
                this.closeUserMenu();
            }
            
            hideChangePasswordModal() {
                document.getElementById('change-password-modal').classList.add('hidden');
                document.getElementById('change-password-form').reset();
                this.clearPasswordErrors();
            }
            
            async handleChangePassword() {
                const form = document.getElementById('change-password-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                // 验证表单
                const validation = FormValidator.validateChangePassword(data);
                if (!validation.isValid) {
                    this.showPasswordErrors(validation.errors);
                    return;
                }
                
                try {
                    await authManager.changePassword(data.oldPassword, data.newPassword);
                    this.hideChangePasswordModal();
                } catch (error) {
                    Utils.showMessage(error.message || '修改密码失败', 'error');
                }
            }
            
            showPasswordErrors(errors) {
                Object.keys(errors).forEach(field => {
                    const errorEl = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`);
                    if (errorEl) {
                        errorEl.textContent = errors[field];
                        errorEl.style.display = 'block';
                    }
                });
            }
            
            clearPasswordErrors() {
                document.querySelectorAll('#change-password-modal .error-message').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            showEditTitleModal() {
                if (!this.currentSession) return;
                
                const input = document.getElementById('session-title-input');
                input.value = this.currentSession.title;
                document.getElementById('edit-title-modal').classList.remove('hidden');
                input.focus();
            }
            
            /**
             * 隐藏编辑标题模态框
             */
            hideEditTitleModal() {
                document.getElementById('edit-title-modal').classList.add('hidden');
                this.editingSession = null; // 清除编辑状态
            }
            
            /**
             * 保存会话标题
             */
            async handleSaveTitle() {
                const input = document.getElementById('session-title-input');
                const newTitle = input.value.trim();
                
                if (!newTitle) {
                    Utils.showMessage('标题不能为空', 'warning');
                    return;
                }
                
                try {
                    // 确定要编辑的会话（优先使用editingSession，否则使用currentSession）
                    const sessionToEdit = this.editingSession || this.currentSession;
                    
                    if (!sessionToEdit) {
                        Utils.showMessage('没有选择要编辑的会话', 'error');
                        return;
                    }
                    
                    await chatManager.updateSessionTitle(sessionToEdit.id, newTitle);
                    
                    // 更新会话对象
                    sessionToEdit.title = newTitle;
                    
                    // 如果编辑的是当前会话，更新顶部标题
                    if (this.currentSession && sessionToEdit.id === this.currentSession.id) {
                        document.getElementById('current-session-title').textContent = newTitle;
                    }
                    
                    // 更新会话列表中的标题
                    const sessionItem = document.querySelector(`[data-session-id="${sessionToEdit.id}"]`);
                    if (sessionItem) {
                        sessionItem.querySelector('.session-title').textContent = newTitle;
                    }
                    
                    this.hideEditTitleModal();
                    this.editingSession = null; // 清除编辑状态
                } catch (error) {
                    Utils.showMessage('更新标题失败', 'error');
                }
            }
            
            clearChat() {
                if (!this.currentSession) return;
                
                if (confirm('确定要清空当前对话吗？此操作不可撤销。')) {
                    // 清空消息显示
                    const container = document.getElementById('chat-messages');
                    const messages = container.querySelectorAll('.message');
                    messages.forEach(msg => msg.remove());
                    
                    // 显示欢迎消息
                    const welcomeMsg = container.querySelector('.welcome-message');
                    if (welcomeMsg) {
                        welcomeMsg.style.display = 'block';
                    }
                    
                    Utils.showMessage('对话已清空', 'success');
                }
            }
            
            /**
             * 编辑会话标题
             * @param {object} session - 会话对象
             */
            editSession(session) {
                // 设置当前编辑的会话
                this.editingSession = session;
                
                // 填充输入框
                const input = document.getElementById('session-title-input');
                input.value = session.title;
                
                // 显示编辑模态框
                document.getElementById('edit-title-modal').classList.remove('hidden');
                input.focus();
                input.select();
            }
            
            async deleteSession(session) {
                console.log('deleteSession方法被调用，会话:', session);
                if (confirm(`确定要删除对话"${session.title}"吗？`)) {
                    console.log('用户确认删除');
                    try {
                        console.log('调用chatManager.deleteSession，sessionId:', session.id);
                        const success = await chatManager.deleteSession(session.id);
                        console.log('删除结果:', success);
                        if (success) {
                            // 刷新会话列表
                            await this.loadSessions();
                            // 如果删除的是当前会话，重置界面
                            if (this.currentSession && this.currentSession.id === session.id) {
                                this.currentSession = null;
                                document.getElementById('current-session-title').textContent = '选择或创建一个对话';
                                document.getElementById('edit-title-btn').style.display = 'none';
                                document.getElementById('clear-chat-btn').style.display = 'none';
                                // 清空消息并显示欢迎界面
                                const container = document.getElementById('chat-messages');
                                const messages = container.querySelectorAll('.message');
                                messages.forEach(msg => msg.remove());
                                const welcomeMsg = container.querySelector('.welcome-message');
                                if (welcomeMsg) {
                                    welcomeMsg.style.display = 'block';
                                }
                            }
                        }
                    } catch (error) {
                        Utils.showMessage('删除会话失败', 'error');
                    }
                }
            }
            
            logout() {
                if (confirm('确定要退出登录吗？')) {
                    authManager.logout();
                }
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            new ChatPage();
        });
    </script>
</body>
</html>