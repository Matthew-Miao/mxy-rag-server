<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“ç®¡ç† - æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/knowledge.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="knowledge-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <div class="header">
            <div class="header-left">
                <a href="chat.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    è¿”å›å¯¹è¯
                </a>
                <h1>
                    <i class="fas fa-database"></i>
                    çŸ¥è¯†åº“ç®¡ç†
                </h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="current-username">ç”¨æˆ·</span>
                    <div class="user-menu">
                        <button class="btn btn-sm" id="user-menu-btn">
                            <i class="fas fa-cog"></i>
                        </button>
                        <div class="dropdown-menu" id="user-dropdown">
                            <a href="#" id="change-password-btn">
                                <i class="fas fa-key"></i>
                                ä¿®æ”¹å¯†ç 
                            </a>
                            <a href="chat.html">
                                <i class="fas fa-comments"></i>
                                æ™ºèƒ½é—®ç­”
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" id="logout-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                é€€å‡ºç™»å½•
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-upload"></i>
                        çŸ¥è¯†ä¸Šä¼ 
                    </h2>
                    <p>æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œæ–‡æœ¬ç›´æ¥è¾“å…¥ä¸¤ç§æ–¹å¼</p>
                </div>
                
                <div class="upload-tabs">
                    <button class="tab-btn active" data-tab="file">
                        <i class="fas fa-file"></i>
                        æ–‡ä»¶ä¸Šä¼ 
                    </button>
                    <button class="tab-btn" data-tab="text">
                        <i class="fas fa-edit"></i>
                        æ–‡æœ¬è¾“å…¥
                    </button>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼ æ ‡ç­¾é¡µ -->
                <div class="tab-content active" id="file-tab">
                    <div class="file-upload-area">
                        <div class="drag-drop-area" id="drag-drop-area">
                            <div class="drag-drop-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h3>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</h3>
                                <p>æ”¯æŒ PDFã€DOCã€DOCXã€TXTã€MD æ ¼å¼</p>
                                <p>å•ä¸ªæ–‡ä»¶æœ€å¤§ 10MB</p>
                                <button class="btn btn-primary" id="select-files-btn">
                                    <i class="fas fa-folder-open"></i>
                                    é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>
                            <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.txt,.md" hidden>
                        </div>
                        
                        <!-- æ–‡ä»¶åˆ—è¡¨ -->
                        <div class="file-list" id="file-list">
                            <div class="file-list-header">
                                <h4>ä¸Šä¼ é˜Ÿåˆ—</h4>
                                <div class="file-actions">
                                    <button class="btn btn-sm btn-secondary" id="clear-queue-btn">
                                        <i class="fas fa-trash"></i>
                                        æ¸…ç©ºé˜Ÿåˆ—
                                    </button>
                                    <button class="btn btn-sm btn-primary" id="upload-all-btn" disabled>
                                        <i class="fas fa-upload"></i>
                                        å¼€å§‹ä¸Šä¼ 
                                    </button>
                                </div>
                            </div>
                            <div class="file-items" id="file-items">
                                <!-- æ–‡ä»¶é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡æœ¬è¾“å…¥æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="text-tab">
                    <div class="text-input-area">
                        <div class="text-input-header">
                            <h4>ç›´æ¥è¾“å…¥æ–‡æœ¬å†…å®¹</h4>
                            <div class="text-actions">
                                <button class="btn btn-sm btn-secondary" id="clear-text-btn">
                                    <i class="fas fa-eraser"></i>
                                    æ¸…ç©º
                                </button>
                                <button class="btn btn-sm btn-primary" id="submit-text-btn" disabled>
                                    <i class="fas fa-plus"></i>
                                    æ·»åŠ åˆ°çŸ¥è¯†åº“
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-input-form">
                            <div class="form-group">
                                <label for="text-title">æ ‡é¢˜</label>
                                <input type="text" id="text-title" placeholder="è¯·è¾“å…¥æ–‡æœ¬æ ‡é¢˜" maxlength="100">
                                <div class="help-text">æœ€å¤š100ä¸ªå­—ç¬¦</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="text-content">å†…å®¹</label>
                                <textarea 
                                    id="text-content" 
                                    placeholder="è¯·è¾“å…¥è¦æ·»åŠ åˆ°çŸ¥è¯†åº“çš„æ–‡æœ¬å†…å®¹..." 
                                    rows="10"
                                    maxlength="10000"
                                ></textarea>
                                <div class="char-count">
                                    <span id="text-char-count">0</span>/10000
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æœç´¢åŒºåŸŸ -->
            <div class="search-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-search"></i>
                        çŸ¥è¯†åº“æœç´¢
                    </h2>
                    <p>æœç´¢å·²ä¸Šä¼ çš„çŸ¥è¯†å†…å®¹</p>
                </div>
                
                <div class="search-form">
                    <div class="search-input-group">
                        <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢çŸ¥è¯†åº“..." maxlength="200">
                        <button class="btn btn-primary" id="search-btn">
                            <i class="fas fa-search"></i>
                            æœç´¢
                        </button>
                    </div>
                </div>
                
                <div class="search-results" id="search-results">
                    <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç å¯¹è¯æ¡† -->
    <div id="change-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿®æ”¹å¯†ç </h3>
                <button class="modal-close" id="close-password-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="current-password">å½“å‰å¯†ç </label>
                        <div class="password-input">
                            <input type="password" id="current-password" name="oldPassword" required>
                            <button type="button" class="password-toggle" data-target="current-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="current-password-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">æ–°å¯†ç </label>
                        <div class="password-input">
                            <input type="password" id="new-password" name="newPassword" required>
                            <button type="button" class="password-toggle" data-target="new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="new-password-error"></div>
                        <div class="help-text">å¯†ç è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-new-password">ç¡®è®¤æ–°å¯†ç </label>
                        <div class="password-input">
                            <input type="password" id="confirm-new-password" name="confirmPassword" required>
                            <button type="button" class="password-toggle" data-target="confirm-new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="confirm-new-password-error"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-password-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="save-password-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½æç¤º -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>å¤„ç†ä¸­...</p>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message-container" class="message-container"></div>
    
    <!-- JavaScript -->
    <script>
        class KnowledgePage {
            constructor() {
                this.currentTab = 'file';
                this.init();
            }
            
            init() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                PageGuard.setup({ requireAuth: true });
                
                this.setupEventListeners();
                this.loadUserInfo();
            }
            
            setupEventListeners() {
                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.tab);
                    });
                });
                
                // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
                document.getElementById('select-files-btn').addEventListener('click', () => {
                    console.log('[KnowledgePage] Select files button clicked');
                    document.getElementById('file-input').click();
                });
                
                document.getElementById('file-input').addEventListener('change', (e) => {
                    console.log('[KnowledgePage] File input changed, files:', e.target.files);
                    this.handleFileSelect(e.target.files);
                });
                
                document.getElementById('clear-queue-btn').addEventListener('click', () => {
                    knowledgeManager.clearQueue();
                });
                
                document.getElementById('upload-all-btn').addEventListener('click', () => {
                    console.log('[KnowledgePage] Upload all button clicked');
                    knowledgeManager.uploadAll();
                });
                
                // æ–‡æœ¬è¾“å…¥ç›¸å…³
                document.getElementById('text-content').addEventListener('input', () => {
                    this.handleTextInput();
                });
                
                document.getElementById('text-title').addEventListener('input', () => {
                    this.updateTextSubmitButton();
                });
                
                document.getElementById('clear-text-btn').addEventListener('click', () => {
                    this.clearTextInput();
                });
                
                document.getElementById('submit-text-btn').addEventListener('click', () => {
                    this.submitText();
                });
                
                // æœç´¢ç›¸å…³
                document.getElementById('search-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch();
                    }
                });
                
                document.getElementById('search-btn').addEventListener('click', () => {
                    this.performSearch();
                });
                
                // ç”¨æˆ·èœå•
                document.getElementById('user-menu-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleUserMenu();
                });
                
                document.addEventListener('click', () => {
                    this.closeUserMenu();
                });
                
                // ä¿®æ”¹å¯†ç 
                document.getElementById('change-password-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showChangePasswordModal();
                });
                
                // é€€å‡ºç™»å½•
                document.getElementById('logout-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });
                
                // æ¨¡æ€æ¡†äº‹ä»¶
                this.setupModalEvents();
                
                // å¯†ç æ˜¾ç¤º/éšè—
                document.querySelectorAll('.password-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget.dataset.target;
                        const input = document.getElementById(target);
                        const icon = e.currentTarget.querySelector('i');
                        
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.className = 'fas fa-eye-slash';
                        } else {
                            input.type = 'password';
                            icon.className = 'fas fa-eye';
                        }
                    });
                });
                
                // ç›‘å¬çŸ¥è¯†åº“ç®¡ç†å™¨äº‹ä»¶
                this.setupKnowledgeEvents();
            }
            
            setupKnowledgeEvents() {
                // æ–‡ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—
                knowledgeManager.on('fileAdded', (e) => {
                    this.updateFileList();
                });
                
                // æ–‡ä»¶çŠ¶æ€å˜åŒ–
                knowledgeManager.on('fileStatusChanged', (e) => {
                    this.updateFileStatus(e.detail.uploadItem);
                });
                
                // ä¸Šä¼ è¿›åº¦æ›´æ–°
                knowledgeManager.on('fileProgress', (e) => {
                    this.updateUploadProgress(e.detail.uploadItem);
                });
                
                // ä¸Šä¼ å®Œæˆ
                knowledgeManager.on('uploadComplete', (e) => {
                    this.onUploadComplete();
                });
                
                // æ–‡ä»¶ç§»é™¤
                knowledgeManager.on('fileRemoved', (e) => {
                    this.updateFileList();
                });
                
                // é˜Ÿåˆ—æ¸…ç©º
                knowledgeManager.on('queueCleared', (e) => {
                    this.updateFileList();
                });
                
                // æœç´¢ç»“æœ
                knowledgeManager.on('searchCompleted', (e) => {
                    this.displaySearchResults(e.detail.results);
                });
            }
            
            setupModalEvents() {
                // ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
                document.getElementById('close-password-modal').addEventListener('click', () => {
                    this.hideChangePasswordModal();
                });
                
                document.getElementById('cancel-password-btn').addEventListener('click', () => {
                    this.hideChangePasswordModal();
                });
                
                document.getElementById('save-password-btn').addEventListener('click', () => {
                    this.handleChangePassword();
                });
            }
            
            loadUserInfo() {
                const user = authManager.getCurrentUser();
                if (user) {
                    document.getElementById('current-username').textContent = user.username || 'ç”¨æˆ·';
                }
            }
            
            switchTab(tabName) {
                if (this.currentTab === tabName) return;
                
                // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                
                // æ›´æ–°å†…å®¹åŒºåŸŸ
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-tab`);
                });
                
                this.currentTab = tabName;
            }
            
            handleFileSelect(files) {
                console.log('[KnowledgePage] handleFileSelect called with files:', files);
                console.log('[KnowledgePage] Number of files selected:', files.length);
                for (let i = 0; i < files.length; i++) {
                    console.log(`[KnowledgePage] File ${i + 1}:`, {
                        name: files[i].name,
                        size: files[i].size,
                        type: files[i].type,
                        lastModified: files[i].lastModified
                    });
                }
                knowledgeManager.addFiles(files);
            }
            
            updateFileList() {
                const container = document.getElementById('file-items');
                const uploadBtn = document.getElementById('upload-all-btn');
                const files = knowledgeManager.getUploadQueue();
                
                container.innerHTML = '';
                
                if (files.length === 0) {
                    container.innerHTML = `
                        <div class="empty-queue">
                            <i class="fas fa-inbox"></i>
                            <p>æš‚æ— æ–‡ä»¶</p>
                        </div>
                    `;
                    uploadBtn.disabled = true;
                    return;
                }
                
                files.forEach(uploadItem => {
                    const item = this.createFileItem(uploadItem);
                    container.appendChild(item);
                });
                
                uploadBtn.disabled = false;
            }
            
            updateFileStatus(uploadItem) {
                const item = document.querySelector(`[data-file-id="${uploadItem.id}"]`);
                if (item) {
                    const statusEl = item.querySelector('.file-status');
                    const actionsEl = item.querySelector('.file-actions');
                    
                    statusEl.className = `file-status ${uploadItem.status}`;
                    statusEl.innerHTML = this.getStatusContent(uploadItem);
                    
                    // æ›´æ–°æ“ä½œæŒ‰é’®
                    if (uploadItem.status === 'pending') {
                        actionsEl.innerHTML = `
                            <button class="action-btn remove-file-btn" data-file-id="${uploadItem.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        const removeBtn = actionsEl.querySelector('.remove-file-btn');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', () => {
                                knowledgeManager.removeFile(uploadItem.id);
                            });
                        }
                    } else {
                        actionsEl.innerHTML = '';
                    }
                }
            }
            
            createFileItem(uploadItem) {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.dataset.fileId = uploadItem.id;
                
                const statusClass = uploadItem.status === 'uploading' ? 'uploading' : 
                                  uploadItem.status === 'completed' ? 'completed' : 
                                  uploadItem.status === 'error' ? 'error' : 'pending';
                
                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas ${this.getFileIcon(uploadItem.file.name)}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${Utils.escapeHtml(uploadItem.file.name)}</div>
                            <div class="file-size">${Utils.formatFileSize(uploadItem.file.size)}</div>
                        </div>
                    </div>
                    <div class="file-status ${statusClass}">
                        ${this.getStatusContent(uploadItem)}
                    </div>
                    <div class="file-actions">
                        ${uploadItem.status === 'pending' ? `
                            <button class="action-btn remove-file-btn" data-file-id="${uploadItem.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
                
                // ç§»é™¤æ–‡ä»¶æŒ‰é’®
                const removeBtn = item.querySelector('.remove-file-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        knowledgeManager.removeFile(uploadItem.id);
                    });
                }
                
                return item;
            }
            
            getFileIcon(filename) {
                const ext = Utils.getFileExtension(filename).toLowerCase();
                switch (ext) {
                    case 'pdf': return 'fa-file-pdf';
                    case 'doc':
                    case 'docx': return 'fa-file-word';
                    case 'txt': return 'fa-file-alt';
                    case 'md': return 'fa-file-code';
                    default: return 'fa-file';
                }
            }
            
            getStatusContent(uploadItem) {
                switch (uploadItem.status) {
                    case 'pending':
                        return '<i class="fas fa-clock"></i> ç­‰å¾…ä¸Šä¼ ';
                    case 'uploading':
                        return `
                            <div class="upload-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${uploadItem.progress || 0}%"></div>
                                </div>
                                <span class="progress-text">${uploadItem.progress || 0}%</span>
                            </div>
                        `;
                    case 'completed':
                        return '<i class="fas fa-check"></i> ä¸Šä¼ æˆåŠŸ';
                    case 'error':
                        return `<i class="fas fa-exclamation-triangle"></i> ${uploadItem.error || 'ä¸Šä¼ å¤±è´¥'}`;
                    default:
                        return '';
                }
            }
            
            updateUploadProgress(uploadItem) {
                const item = document.querySelector(`[data-file-id="${uploadItem.id}"]`);
                if (item) {
                    const statusEl = item.querySelector('.file-status');
                    statusEl.className = 'file-status uploading';
                    statusEl.innerHTML = this.getStatusContent(uploadItem);
                }
            }
            
            onUploadComplete() {
                // ä¸Šä¼ å®Œæˆååˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                this.updateFileList();
                
                // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                Utils.showMessage('æ–‡ä»¶ä¸Šä¼ å®Œæˆ', 'success');
            }
            
            handleTextInput() {
                const textarea = document.getElementById('text-content');
                const charCount = document.getElementById('text-char-count');
                
                charCount.textContent = textarea.value.length;
                this.updateTextSubmitButton();
            }
            
            updateTextSubmitButton() {
                const title = document.getElementById('text-title').value.trim();
                const content = document.getElementById('text-content').value.trim();
                const submitBtn = document.getElementById('submit-text-btn');
                
                submitBtn.disabled = !title || !content;
            }
            
            clearTextInput() {
                document.getElementById('text-title').value = '';
                document.getElementById('text-content').value = '';
                document.getElementById('text-char-count').textContent = '0';
                this.updateTextSubmitButton();
            }
            
            async submitText() {
                const title = document.getElementById('text-title').value.trim();
                const content = document.getElementById('text-content').value.trim();
                
                if (!title || !content) {
                    Utils.showMessage('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹', 'warning');
                    return;
                }
                
                try {
                    await knowledgeManager.insertText(title, content);
                    this.clearTextInput();
                } catch (error) {
                    Utils.showMessage(error.message || 'æ·»åŠ æ–‡æœ¬å¤±è´¥', 'error');
                }
            }
            
            async performSearch() {
                const query = document.getElementById('search-input').value.trim();
                
                if (!query) {
                    Utils.showMessage('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                    return;
                }
                
                try {
                    await knowledgeManager.search(query);
                } catch (error) {
                    Utils.showMessage(error.message || 'æœç´¢å¤±è´¥', 'error');
                }
            }
            
            displaySearchResults(results) {
                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“æœç´¢ç»“æœ:', results);
                console.log('ğŸ“Š ç»“æœæ•°é‡:', results.length);
                
                const container = document.getElementById('search-results');
                
                if (results.length === 0) {
                    console.log('âŒ æ²¡æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                    container.innerHTML = `
                        <div class="empty-results">
                            <i class="fas fa-search"></i>
                            <h3>æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</h3>
                            <p>è¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('âœ… å¼€å§‹æ¸²æŸ“æœç´¢ç»“æœåˆ—è¡¨');
                container.innerHTML = `
                    <div class="results-header">
                        <h3>æœç´¢ç»“æœ (${results.length})</h3>
                    </div>
                    <div class="results-list">
                        ${results.map((result, index) => {
                            console.log(`ğŸ“„ æ¸²æŸ“ç¬¬${index + 1}ä¸ªç»“æœ:`, result);
                            return this.createResultItem(result);
                        }).join('')}
                    </div>
                `;
                console.log('ğŸ‰ æœç´¢ç»“æœæ¸²æŸ“å®Œæˆ');
            }
            
            createResultItem(result) {
                // å¤„ç†Spring AI Documentå¯¹è±¡çš„æ•°æ®ç»“æ„
                const title = result.metadata?.title || result.metadata?.source || result.id || 'æœªå‘½åæ–‡æ¡£';
                const content = result.content || '';
                const source = result.metadata?.source || result.metadata?.file_name || 'æœªçŸ¥æ¥æº';
                const score = result.metadata?.distance ? (1 - result.metadata.distance) : 0.8; // è·ç¦»è½¬æ¢ä¸ºç›¸ä¼¼åº¦
                const createTime = result.metadata?.create_time || result.metadata?.timestamp;
                
                return `
                    <div class="result-item">
                        <div class="result-header">
                            <h4>${Utils.escapeHtml(title)}</h4>
                            <div class="result-score">
                                ç›¸å…³åº¦: ${Math.round(score * 100)}%
                            </div>
                        </div>
                        <div class="result-content">
                            ${Utils.escapeHtml(content).substring(0, 200)}${content.length > 200 ? '...' : ''}
                        </div>
                        <div class="result-meta">
                            <span class="result-source">
                                <i class="fas fa-file"></i>
                                ${Utils.escapeHtml(source)}
                            </span>
                            ${createTime ? `<span class="result-time">
                                ${Utils.formatTime(createTime)}
                            </span>` : ''}
                        </div>
                    </div>
                `;
            }
            
            toggleUserMenu() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.toggle('show');
            }
            
            closeUserMenu() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.remove('show');
            }
            
            showChangePasswordModal() {
                document.getElementById('change-password-modal').classList.remove('hidden');
                this.closeUserMenu();
            }
            
            hideChangePasswordModal() {
                document.getElementById('change-password-modal').classList.add('hidden');
                document.getElementById('change-password-form').reset();
                this.clearPasswordErrors();
            }
            
            async handleChangePassword() {
                const form = document.getElementById('change-password-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                // éªŒè¯è¡¨å•
                const validation = FormValidator.validateChangePassword(data);
                if (!validation.isValid) {
                    this.showPasswordErrors(validation.errors);
                    return;
                }
                
                try {
                    await authManager.changePassword(data.oldPassword, data.newPassword);
                    this.hideChangePasswordModal();
                } catch (error) {
                    Utils.showMessage(error.message || 'ä¿®æ”¹å¯†ç å¤±è´¥', 'error');
                }
            }
            
            showPasswordErrors(errors) {
                Object.keys(errors).forEach(field => {
                    const errorEl = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`);
                    if (errorEl) {
                        errorEl.textContent = errors[field];
                        errorEl.style.display = 'block';
                    }
                });
            }
            
            clearPasswordErrors() {
                document.querySelectorAll('#change-password-modal .error-message').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            logout() {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    authManager.logout();
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new KnowledgePage();
        });
    </script>
    
    <!-- å¼•å…¥å¿…è¦çš„JavaScriptæ–‡ä»¶ -->
    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/knowledge.js"></script>
</body>
</html>