<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 智能问答系统</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <h1>智能问答系统</h1>
                </div>
                <p class="subtitle">欢迎使用基于RAG的智能问答平台</p>
            </div>
            
            <div class="login-tabs">
                <button class="tab-btn active" data-tab="login">
                    <i class="fas fa-sign-in-alt"></i>
                    登录
                </button>
                <button class="tab-btn" data-tab="register">
                    <i class="fas fa-user-plus"></i>
                    注册
                </button>
            </div>
            
            <!-- 登录表单 -->
            <div class="tab-content active" id="login-tab">
                <form id="login-form" class="auth-form">
                    <div class="form-group">
                        <label for="login-username">
                            <i class="fas fa-user"></i>
                            用户名
                        </label>
                        <input 
                            type="text" 
                            id="login-username" 
                            name="username" 
                            placeholder="请输入用户名"
                            required
                            autocomplete="username"
                        >
                        <div class="error-message" id="login-username-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">
                            <i class="fas fa-lock"></i>
                            密码
                        </label>
                        <div class="password-input">
                            <input 
                                type="password" 
                                id="login-password" 
                                name="password" 
                                placeholder="请输入密码"
                                required
                                autocomplete="current-password"
                            >
                            <button type="button" class="password-toggle" data-target="login-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="login-password-error"></div>
                    </div>
                    
                    <div class="form-options">
                        <a href="#" class="forgot-password">忘记密码？</a>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        登录
                    </button>
                </form>
            </div>
            
            <!-- 注册表单 -->
            <div class="tab-content" id="register-tab">
                <form id="register-form" class="auth-form">
                    <div class="form-group">
                        <label for="register-username">
                            <i class="fas fa-user"></i>
                            用户名
                        </label>
                        <input 
                            type="text" 
                            id="register-username" 
                            name="username" 
                            placeholder="请输入用户名（3-20个字符）"
                            required
                            autocomplete="username"
                        >
                        <div class="error-message" id="register-username-error"></div>
                        <div class="help-text">用户名只能包含字母、数字和下划线</div>
                    </div>
                    

                    
                    <div class="form-group">
                        <label for="register-password">
                            <i class="fas fa-lock"></i>
                            密码
                        </label>
                        <div class="password-input">
                            <input 
                                type="password" 
                                id="register-password" 
                                name="password" 
                                placeholder="请输入密码（至少8位）"
                                required
                                autocomplete="new-password"
                            >
                            <button type="button" class="password-toggle" data-target="register-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="register-password-error"></div>
                        <div class="help-text">密码至少8位，包含字母和数字</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-confirm-password">
                            <i class="fas fa-lock"></i>
                            确认密码
                        </label>
                        <div class="password-input">
                            <input 
                                type="password" 
                                id="register-confirm-password" 
                                name="confirmPassword" 
                                placeholder="请再次输入密码"
                                required
                                autocomplete="new-password"
                            >
                            <button type="button" class="password-toggle" data-target="register-confirm-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="register-confirm-password-error"></div>
                    </div>
                    
                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agree-terms" name="agreeTerms" required>
                            <span class="checkmark"></span>
                            我同意 <a href="#" class="terms-link">用户协议</a> 和 <a href="#" class="privacy-link">隐私政策</a>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" id="register-btn">
                        <i class="fas fa-user-plus"></i>
                        注册
                    </button>
                </form>
            </div>
        </div>
        
        <div class="login-footer">
            <p>&copy; 2024 智能问答系统. All rights reserved.</p>
        </div>
    </div>
    
    <!-- 加载提示 -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>处理中...</p>
        </div>
    </div>
    
    <!-- 消息提示 -->
    <div id="message-container" class="message-container"></div>
    
    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        class LoginPage {
            constructor() {
                this.currentTab = 'login';
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupFormValidation();
                this.checkAuthStatus();
            }
            
            setupEventListeners() {
                // 标签切换
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.currentTarget.dataset.tab;
                        this.switchTab(tab);
                    });
                });
                
                // 密码显示/隐藏
                document.querySelectorAll('.password-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget.dataset.target;
                        const input = document.getElementById(target);
                        const icon = e.currentTarget.querySelector('i');
                        
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.className = 'fas fa-eye-slash';
                        } else {
                            input.type = 'password';
                            icon.className = 'fas fa-eye';
                        }
                    });
                });
                
                // 表单提交
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                document.getElementById('register-form').addEventListener('submit', (e) => {
                    console.log('注册表单 submit 事件被触发');
                    e.preventDefault();
                    console.log('调用 handleRegister 方法');
                    this.handleRegister();
                });
                
                // 用户名实时检查（注册时）
                const registerUsername = document.getElementById('register-username');
                if (registerUsername) {
                    registerUsername.addEventListener('blur', Utils.debounce((e) => {
                        this.checkUsername(e.target.value);
                    }, 500));
                }
            }
            
            setupFormValidation() {
                // 实时验证
                const inputs = document.querySelectorAll('input[required]');
                inputs.forEach(input => {
                    input.addEventListener('blur', () => {
                        this.validateField(input);
                    });
                    
                    input.addEventListener('input', () => {
                        this.clearFieldError(input);
                    });
                });
            }
            
            checkAuthStatus() {
                // 延迟检查认证状态，避免页面加载时立即跳转
                setTimeout(() => {
                    if (authManager.isLoggedIn()) {
                        // 验证token是否真的有效
                        const token = Storage.get(CONFIG.TOKEN_KEY);
                        if (token && !authManager.isTokenExpiringSoon(token)) {
                            window.location.href = '/chat.html';
                        } else {
                             // token无效或过期，清除认证信息但不跳转
                             Storage.remove(CONFIG.TOKEN_KEY);
                             Storage.remove(CONFIG.USER_KEY);
                             authManager.currentUser = null;
                         }
                    }
                }, 500); // 延迟500ms检查
            }
            
            switchTab(tab) {
                if (this.currentTab === tab) return;
                
                // 更新标签按钮
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tab);
                });
                
                // 更新内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tab}-tab`);
                });
                
                this.currentTab = tab;
                this.clearAllErrors();
            }
            
            async handleLogin() {
                const form = document.getElementById('login-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                // 验证表单
                const validation = FormValidator.validateLogin(data);
                if (!validation.isValid) {
                    this.showFormErrors('login', validation.errors);
                    return;
                }
                
                try {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    Utils.showLoading(submitBtn, true);
                    
                    await authManager.login(
                        data.username,
                        data.password,
                        false
                    );
                    
                    Utils.showMessage('登录成功', 'success');
                    
                    // 延迟跳转，让用户看到成功消息
                    setTimeout(() => {
                        window.location.href = '/chat.html';
                    }, 1000);
                    
                } catch (error) {
                    Utils.showMessage(error.message || '登录失败', 'error');
                } finally {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    Utils.showLoading(submitBtn, false);
                }
            }
            
            async handleRegister() {
                console.log('handleRegister 方法被调用');
                
                const form = document.getElementById('register-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                console.log('表单数据:', data);
                
                // 验证表单
                const validation = FormValidator.validateRegister(data);
                console.log('表单验证结果:', validation);
                
                if (!validation.isValid) {
                    console.log('表单验证失败:', validation.errors);
                    this.showFormErrors('register', validation.errors);
                    return;
                }
                
                try {
                    console.log('开始调用注册接口');
                    const submitBtn = form.querySelector('button[type="submit"]');
                    Utils.showLoading(submitBtn, true);
                    
                    const registerData = {
                        username: data.username,
                        password: data.password,
                        confirmPassword: data.confirmPassword
                    };
                    console.log('注册请求数据:', registerData);
                    
                    const result = await authManager.register(registerData);
                    console.log('注册接口返回结果:', result);
                    
                    Utils.showMessage('注册成功', 'success');
                    
                    // 延迟跳转，让用户看到成功消息
                    setTimeout(() => {
                        window.location.href = '/chat.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('注册失败:', error);
                    Utils.showMessage(error.message || '注册失败', 'error');
                } finally {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    Utils.showLoading(submitBtn, false);
                }
            }
            
            async checkUsername(username) {
                if (!username || username.length < 3) return;
                
                try {
                    const available = await authManager.checkUsername(username);
                    const errorEl = document.getElementById('register-username-error');
                    
                    if (!available) {
                        errorEl.textContent = '用户名已被使用';
                        errorEl.style.display = 'block';
                    } else {
                        errorEl.style.display = 'none';
                    }
                } catch (error) {
                    console.error('检查用户名失败:', error);
                }
            }
            
            validateField(input) {
                const value = input.value.trim();
                const name = input.name;
                let error = '';
                
                switch (name) {
                    case 'username':
                        if (!value || value.length < 3) {
                            error = '用户名至少需要3个字符';
                        } else if (!/^[a-zA-Z0-9_]+$/.test(value)) {
                            error = '用户名只能包含字母、数字和下划线';
                        }
                        break;

                    case 'password':
                        if (!Utils.validatePassword(value)) {
                            error = '密码至少8位，包含字母和数字';
                        }
                        break;
                    case 'confirmPassword':
                        const password = document.querySelector(`#${this.currentTab}-password`).value;
                        if (value !== password) {
                            error = '两次输入的密码不一致';
                        }
                        break;
                }
                
                this.showFieldError(input, error);
                return !error;
            }
            
            showFieldError(input, error) {
                const errorEl = document.getElementById(`${input.id}-error`);
                if (errorEl) {
                    errorEl.textContent = error;
                    errorEl.style.display = error ? 'block' : 'none';
                }
                
                input.classList.toggle('error', !!error);
            }
            
            clearFieldError(input) {
                this.showFieldError(input, '');
            }
            
            showFormErrors(form, errors) {
                Object.keys(errors).forEach(field => {
                    const input = document.getElementById(`${form}-${field}`);
                    if (input) {
                        this.showFieldError(input, errors[field]);
                    }
                });
            }
            
            clearAllErrors() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
                
                document.querySelectorAll('input.error').forEach(input => {
                    input.classList.remove('error');
                });
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            new LoginPage();
        });
    </script>
</body>
</html>