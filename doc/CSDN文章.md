# ğŸš€ åŸºäºSpring AI Alibabaçš„æ™ºèƒ½çŸ¥è¯†åŠ©æ‰‹ç³»ç»Ÿï¼šä»é›¶åˆ°ä¸€çš„RAGå®æˆ˜å¼€å‘

## ğŸ“– é¡¹ç›®æ¦‚è¿°

åœ¨äººå·¥æ™ºèƒ½å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼ŒRAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€æœ¯å·²æˆä¸ºæ„å»ºæ™ºèƒ½é—®ç­”ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä¸€ä¸ªåŸºäº**Spring AI Alibaba DashScope**æ·±åº¦é›†æˆçš„æ™ºèƒ½çŸ¥è¯†åŠ©æ‰‹ç³»ç»Ÿçš„å®Œæ•´å¼€å‘è¿‡ç¨‹ï¼Œè¯¥ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆï¼Œå®ç°äº†ä¼ä¸šçº§çš„RAGè§£å†³æ–¹æ¡ˆã€‚

**é¡¹ç›®åœ°å€**ï¼š[https://github.com/Matthew-Miao/mxy-rag-server](https://github.com/Matthew-Miao/mxy-rag-server)

## ğŸ¯ é¡¹ç›®æ ¸å¿ƒä»·å€¼

### æŠ€æœ¯åˆ›æ–°ç‚¹
- **æ·±åº¦é›†æˆSpring AI Alibaba**ï¼šåŸç”Ÿæ”¯æŒé˜¿é‡Œäº‘é€šä¹‰åƒé—®æ¨¡å‹ï¼Œæä¾›ç»Ÿä¸€çš„AIæ¥å£
- **åŒæ¨¡å¼AIæ”¯æŒ**ï¼šåŒæ—¶æ”¯æŒSpring AI Alibaba DashScopeå’ŒOpenAIå…¼å®¹æ¨¡å¼
- **ä¼ä¸šçº§RAGæ¶æ„**ï¼šå®Œæ•´çš„æ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿï¼Œæ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼
- **ç°ä»£åŒ–æŠ€æœ¯æ ˆ**ï¼šSpring Boot 3.x + PostgreSQL + pgvector + MySQL
- **ç”¨æˆ·ä¼šè¯ç®¡ç†**ï¼šåŸºäºThreadLocalçš„ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿ

### ä¸šåŠ¡ä»·å€¼
- **æ™ºèƒ½çŸ¥è¯†é—®ç­”**ï¼šåŸºäºç”¨æˆ·ä¸Šä¼ çš„æ–‡æ¡£è¿›è¡Œç²¾å‡†é—®ç­”
- **å¤šä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¸ªå¯¹è¯ä¼šè¯ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
- **å®æ—¶æµå¼å¯¹è¯**ï¼šæ”¯æŒæµå¼å“åº”ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **çŸ¥è¯†åº“ç®¡ç†**ï¼šå®Œæ•´çš„æ–‡æ¡£ä¸Šä¼ ã€å¤„ç†ã€æ£€ç´¢åŠŸèƒ½

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯å±•ç¤ºå±‚     â”‚    â”‚   ä¸šåŠ¡é€»è¾‘å±‚     â”‚    â”‚   æ•°æ®å­˜å‚¨å±‚     â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ HTML5 + CSS3   â”‚â—„â”€â”€â–ºâ”‚ Spring Boot    â”‚â—„â”€â”€â–ºâ”‚ PostgreSQL     â”‚
â”‚ åŸç”ŸJavaScript â”‚    â”‚ Spring AI      â”‚    â”‚ + pgvector     â”‚
â”‚ Font Awesome   â”‚    â”‚ MyBatis        â”‚    â”‚                â”‚
â”‚ WebSocket      â”‚    â”‚ WebSocket      â”‚    â”‚ MySQL          â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   AIæœåŠ¡å±‚      â”‚
                    â”‚                â”‚
                    â”‚ é˜¿é‡Œäº‘é€šä¹‰åƒé—®   â”‚
                    â”‚ DashScope API  â”‚
                    â”‚ æ–‡æœ¬åµŒå…¥æ¨¡å‹    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆè¯¦è§£

#### åç«¯æŠ€æœ¯æ ˆ
- **Spring Boot 3.2.0**ï¼šç°ä»£åŒ–çš„Javaä¼ä¸šçº§æ¡†æ¶
- **Spring AI Alibaba**ï¼šé˜¿é‡Œäº‘AIæœåŠ¡çš„Springé›†æˆ
- **MyBatis**ï¼šçµæ´»çš„æŒä¹…å±‚æ¡†æ¶
- **PostgreSQL + pgvector**ï¼šå‘é‡æ•°æ®åº“ï¼Œæ”¯æŒç›¸ä¼¼æ€§æœç´¢
- **MySQL**ï¼šä¸šåŠ¡æ•°æ®å­˜å‚¨
- **ThreadLocal**ï¼šç”¨æˆ·ä¼šè¯ç®¡ç†
- **WebSocket**ï¼šå®æ—¶é€šä¿¡æ”¯æŒ

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **HTML5**ï¼šç°ä»£åŒ–çš„æ ‡è®°è¯­è¨€ï¼Œæ”¯æŒè¯­ä¹‰åŒ–æ ‡ç­¾
- **CSS3**ï¼šæ ·å¼è®¾è®¡ï¼Œæ”¯æŒFlexboxã€Gridã€åŠ¨ç”»ç­‰ç°ä»£ç‰¹æ€§
- **åŸç”ŸJavaScript (ES6+)**ï¼šæ— æ¡†æ¶ä¾èµ–çš„çº¯JavaScriptå®ç°
- **Font Awesome 6.0**ï¼šå›¾æ ‡åº“ï¼Œæä¾›ä¸°å¯Œçš„çŸ¢é‡å›¾æ ‡
- **Marked.js**ï¼šMarkdownè§£æåº“ï¼Œæ”¯æŒæ¶ˆæ¯æ ¼å¼åŒ–
- **Highlight.js**ï¼šä»£ç é«˜äº®åº“ï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€
- **Fetch API**ï¼šç°ä»£åŒ–çš„HTTPè¯·æ±‚æ¥å£
- **WebSocket**ï¼šå®æ—¶é€šä¿¡æ”¯æŒ

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. Spring AI Alibabaé›†æˆ

#### Mavenä¾èµ–é…ç½®

```xml
<dependency>
    <groupId>com.alibaba.cloud.ai</groupId>
    <artifactId>spring-ai-alibaba-starter-dashscope</artifactId>
    <version>1.0.0.2</version>
</dependency>
```

#### é…ç½®æ–‡ä»¶è®¾ç½®

```yaml
spring:
  ai:
        vectorstore:
      pgvector:
        table-name: mxy_rag_vector
        initialize-schema: true
        dimensions: 1024
        index-type: hnsw
    dashscope:
      api-key: ${AI_DASHSCOPE_API_KEY}
      chat:
        options:
          model: qwen-plus-latest
      embedding:
        options:
          model: text-embedding-v3
          dimensions: 1024
 #    openai:
#      api-key: ${AI_DASHSCOPE_API_KEY}
#      base-url: https://dashscope.aliyuncs.com/compatible-mode
#      chat:
#        options:
#          model: qwen-plus-latest
#      embedding:
#        options:
#          model: text-embedding-v3
#          dimensions: 1024
```

#### æ ¸å¿ƒæœåŠ¡å®ç°

**KnowledgeBaseServiceImpl.java - çŸ¥è¯†åº“æœåŠ¡æ ¸å¿ƒå®ç°ï¼š**

```java
/**
 * çŸ¥è¯†åº“æœåŠ¡å®ç°ç±»
 * @author Mxy
 */
@Service
public class KnowledgeBaseServiceImpl implements KnowledgeBaseService {

    private static final Logger logger = LoggerFactory.getLogger(KnowledgeBaseServiceImpl.class);
    
    /**
     * ç³»ç»Ÿæç¤ºè¯ï¼šæŒ‡å¯¼AIæ™ºèƒ½åœ°å¤„ç†ä¸åŒç±»å‹çš„é—®é¢˜
     */
    private static final String SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚è¯·å§‹ç»ˆä½¿ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å½“å›ç­”ç”¨æˆ·é—®é¢˜æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹ç­–ç•¥ï¼š\n" +
            "1. å¯¹äºåŸºç¡€çŸ¥è¯†é—®é¢˜ï¼ˆå¦‚æ•°å­¦è®¡ç®—ã€å¸¸è¯†é—®é¢˜ç­‰ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ä½ çš„é€šç”¨çŸ¥è¯†å‡†ç¡®å›ç­”\n" +
            "2. å¯¹äºä¸“ä¸šæˆ–ç‰¹å®šé¢†åŸŸçš„é—®é¢˜ï¼Œä¼˜å…ˆä»å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³çŸ¥è¯†æ¥å›ç­”\n" +
            "3. å¦‚æœå‘é‡æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·ä»èŠå¤©è®°å¿†ä¸­å¯»æ‰¾ä¹‹å‰è®¨è®ºè¿‡çš„ç›¸å…³å†…å®¹\n" +
            "4. å¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·åŸºäºä½ çš„é€šç”¨çŸ¥è¯†ç»™å‡ºå‡†ç¡®ã€æœ‰å¸®åŠ©çš„å›ç­”\n" +
            "5. åªæœ‰åœ¨ç¡®å®æ— æ³•å›ç­”æ—¶ï¼Œæ‰è¯šå®åœ°å‘ŠçŸ¥ç”¨æˆ·å¹¶å»ºè®®ä»–ä»¬æä¾›æ›´å¤šä¿¡æ¯\n" +
            "è¯·ç¡®ä¿å›ç­”å‡†ç¡®ã€ç›¸å…³ä¸”æœ‰å¸®åŠ©ã€‚ä¸è¦å› ä¸ºå‘é‡æ•°æ®åº“ä¸­æ²¡æœ‰ä¿¡æ¯å°±æ‹’ç»å›ç­”åŸºç¡€é—®é¢˜ã€‚æ‰€æœ‰å›ç­”éƒ½å¿…é¡»ä½¿ç”¨ä¸­æ–‡ã€‚";

    private final VectorStore vectorStore;
    private final ChatClient chatClient;
    
    /**
     * æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–çŸ¥è¯†åº“æœåŠ¡
     * 
     * @param vectorStore å‘é‡å­˜å‚¨
     * @param chatModel èŠå¤©æ¨¡å‹
     * @param messageWindowChatMemory æ¶ˆæ¯çª—å£èŠå¤©è®°å¿†
     */
    public KnowledgeBaseServiceImpl(VectorStore vectorStore, 
                                    @Qualifier("dashscopeChatModel") ChatModel chatModel,
                                    MessageWindowChatMemory messageWindowChatMemory) {
        this.vectorStore = vectorStore;
        this.chatClient = ChatClient.builder(chatModel)
                .defaultAdvisors(
                    SimpleLoggerAdvisor.builder().build(),
                    MessageChatMemoryAdvisor.builder(messageWindowChatMemory).build()
                )
                .defaultOptions(DashScopeChatOptions.builder().withTopP(0.7).build())
                .build();
    }
    
    /**
     * ä¸çŸ¥è¯†åº“è¿›è¡Œå¯¹è¯
     * 
     * @param query ç”¨æˆ·æŸ¥è¯¢
     * @param conversationId å¯¹è¯ID
     * @param topK æ£€ç´¢æ–‡æ¡£æ•°é‡
     * @return å›ç­”å†…å®¹
     */
    @Override
    public String chatWithKnowledge(String query, String conversationId, int topK) {
        Assert.hasText(query, "æŸ¥è¯¢é—®é¢˜ä¸èƒ½ä¸ºç©º");
        logger.info("å¼€å§‹çŸ¥è¯†åº“å¯¹è¯ï¼ŒæŸ¥è¯¢: '{}', conversationId: {}", query, conversationId);
        
        try {
            String prompt = getRagStr(query, topK);
            
            // è°ƒç”¨LLMç”Ÿæˆå›ç­”
            String answer = chatClient.prompt(prompt)
                    .system(SYSTEM_PROMPT)
                    .user(query)
                    .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, conversationId))
                    .call().content();

            logger.info("çŸ¥è¯†åº“å¯¹è¯å®Œæˆï¼ŒæŸ¥è¯¢: '{}'", query);
            return answer;
            
        } catch (Exception e) {
            logger.error("çŸ¥è¯†åº“å¯¹è¯å¤±è´¥ï¼ŒæŸ¥è¯¢: '{}'", query, e);
            return "å¯¹è¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }
    
    /**
     * æµå¼çŸ¥è¯†åº“å¯¹è¯
     * 
     * @param query ç”¨æˆ·æŸ¥è¯¢
     * @param conversationId å¯¹è¯ID
     * @param topK æ£€ç´¢æ–‡æ¡£æ•°é‡
     * @return æµå¼å›ç­”å†…å®¹
     */
    @Override
    public Flux<String> chatWithKnowledgeStream(String query, String conversationId, int topK) {
        Assert.hasText(query, "æŸ¥è¯¢é—®é¢˜ä¸èƒ½ä¸ºç©º");
        logger.info("å¼€å§‹æµå¼çŸ¥è¯†åº“å¯¹è¯ï¼ŒæŸ¥è¯¢: '{}', conversationId: {}", query, conversationId);

        try {
            String prompt = getRagStr(query, topK);

            return chatClient.prompt(prompt)
                    .system(SYSTEM_PROMPT)
                    .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, conversationId))
                    .user(query)
                    .stream()
                    .content();
        } catch (Exception e) {
             logger.error("æµå¼çŸ¥è¯†åº“å¯¹è¯å¤±è´¥ï¼ŒæŸ¥è¯¢: '{}'", query, e);
             return Flux.just("å¯¹è¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + e.getMessage());
         }
    }
    
    /**
     * ç›¸ä¼¼æ€§æœç´¢
     * 
     * @param query æŸ¥è¯¢å­—ç¬¦ä¸²
     * @param topK è¿”å›çš„ç›¸ä¼¼æ–‡æ¡£æ•°é‡
     * @return ç›¸ä¼¼æ–‡æ¡£åˆ—è¡¨
     */
    @Override
    public List<Document> similaritySearch(String query, int topK) {
        Assert.hasText(query, "æŸ¥è¯¢ä¸èƒ½ä¸ºç©º");
        logger.info("æ‰§è¡Œç›¸ä¼¼æ€§æœç´¢: query={}, topK={}", query, topK);

        SearchRequest searchRequest = SearchRequest.builder()
                .query(query)
                .topK(topK)
                .build();

        List<Document> results = vectorStore.similaritySearch(searchRequest);
        logger.info("ç›¸ä¼¼æ€§æœç´¢å®Œæˆï¼Œæ‰¾åˆ° {} ä¸ªç›¸å…³æ–‡æ¡£", results.size());
        return results;
    }
    
    /**
     * è·å–RAGæç¤ºè¯
     *
     * @param query ç”¨æˆ·æŸ¥è¯¢
     * @param topK æ£€ç´¢æ–‡æ¡£æ•°é‡
     * @return æç¤ºè¯
     */
    private String getRagStr(String query, int topK) {
        List<Document> documents = similaritySearch(query, topK);
        String prompt = "";
        if (documents != null && !documents.isEmpty()){
            // æ„å»ºæç¤ºè¯
            String context = documents.stream()
                    .map(Document::getText)
                    .collect(Collectors.joining("\n\n"));
            prompt = String.format("çŸ¥è¯†åº“å†…å®¹ï¼š\n%s\n\n", context);
        }
        return prompt;
    }
}
```

### 2. ç”¨æˆ·ä¼šè¯ç®¡ç†ç³»ç»Ÿ

#### ç”¨æˆ·ä¼šè¯ä¿¡æ¯ç±»

```java
@Data
public class UserSession {
    
    /**
     * ç”¨æˆ·ID
     */
    private String userId;
    
    /**
     * ç”¨æˆ·å
     */
    private String username;

    public UserSession() {
    }
    
    public UserSession(String userId, String username) {
        this();
        this.userId = userId;
        this.username = username;
    }
}
```

#### ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾è®¡ï¼ˆæ”¯æŒTTLï¼‰

```java
/**
 * ç”¨æˆ·ä¼šè¯æŒæœ‰è€…
 * ä½¿ç”¨é˜¿é‡ŒTTLï¼ˆTransmittableThreadLocalï¼‰å­˜å‚¨å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¼šè¯ä¿¡æ¯
 * æ”¯æŒçº¿ç¨‹æ± ç¯å¢ƒä¸‹çš„ä¸Šä¸‹æ–‡ä¼ é€’ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨
 * 
 * @author Mxy
 */
public class UserSessionHolder {
    
    private static final Logger logger = LoggerFactory.getLogger(UserSessionHolder.class);
    
    /**
     * TransmittableThreadLocalå­˜å‚¨ç”¨æˆ·ä¼šè¯ä¿¡æ¯
     * ç›¸æ¯”ThreadLocalï¼ŒTTLæ”¯æŒçº¿ç¨‹æ± ç¯å¢ƒä¸‹çš„ä¸Šä¸‹æ–‡ä¼ é€’
     */
    private static final TransmittableThreadLocal<UserSession> USER_SESSION_THREAD_LOCAL = new TransmittableThreadLocal<>();
    
    /**
     * è®¾ç½®å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¼šè¯
     * 
     * @param userSession ç”¨æˆ·ä¼šè¯ä¿¡æ¯
     */
    public static void setUserSession(UserSession userSession) {
        if (userSession != null) {
            logger.debug("è®¾ç½®ç”¨æˆ·ä¼šè¯: {}", userSession);
            USER_SESSION_THREAD_LOCAL.set(userSession);
        } else {
            logger.warn("å°è¯•è®¾ç½®ç©ºçš„ç”¨æˆ·ä¼šè¯");
        }
    }
    
    /**
     * è·å–å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¼šè¯
     * 
     * @return ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼Œå¦‚æœæœªè®¾ç½®åˆ™è¿”å›null
     */
    public static UserSession getUserSession() {
        return USER_SESSION_THREAD_LOCAL.get();
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·ID
     * 
     * @return ç”¨æˆ·IDï¼Œå¦‚æœæœªè®¾ç½®ä¼šè¯åˆ™è¿”å›null
     */
    public static String getCurrentUserId() {
        UserSession session = getUserSession();
        return session != null ? session.getUserId() : null;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·å
     * 
     * @return ç”¨æˆ·åï¼Œå¦‚æœæœªè®¾ç½®ä¼šè¯åˆ™è¿”å›null
     */
    public static String getCurrentUsername() {
        UserSession session = getUserSession();
        return session != null ? session.getUsername() : null;
    }
    
    /**
     * æ¸…é™¤å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¼šè¯
     * é‡è¦ï¼šåœ¨è¯·æ±‚å¤„ç†å®Œæˆåå¿…é¡»è°ƒç”¨æ­¤æ–¹æ³•ï¼Œé¿å…å†…å­˜æ³„æ¼
     */
    public static void clearUserSession() {
        UserSession session = getUserSession();
        if (session != null) {
            logger.debug("æ¸…é™¤ç”¨æˆ·ä¼šè¯: userId={}", session.getUserId());
        }
        USER_SESSION_THREAD_LOCAL.remove();
    }
}
```

#### ç”¨æˆ·è®¤è¯æ‹¦æˆªå™¨

```java
/**
 * ç”¨æˆ·è®¤è¯æ‹¦æˆªå™¨
 * æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ŒéªŒè¯è¯·æ±‚å¤´ä¸­çš„userIdï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°UserSessionä¸­
 * 
 * @author Mxy
 */
@Component
public class UserAuthInterceptor implements HandlerInterceptor {
    
    private static final Logger logger = LoggerFactory.getLogger(UserAuthInterceptor.class);
    
    /**
     * ç”¨æˆ·IDè¯·æ±‚å¤´åç§°
     */
    private static final String USER_ID_HEADER = "X-User-Id";
    
    /**
     * å¤‡ç”¨ç”¨æˆ·IDè¯·æ±‚å¤´åç§°
     */
    private static final String USER_ID_HEADER_ALT = "userId";
    
    @Resource
    private UsersDAO usersDAO;
    
    /**
     * è¯·æ±‚å¤„ç†å‰çš„æ‹¦æˆªæ–¹æ³•
     * éªŒè¯ç”¨æˆ·èº«ä»½å¹¶è®¾ç½®ç”¨æˆ·ä¼šè¯
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String requestURI = request.getRequestURI();
        String method = request.getMethod();
        
        logger.debug("æ‹¦æˆªè¯·æ±‚: {} {}", method, requestURI);
        
        // è·³è¿‡å¥åº·æ£€æŸ¥å’Œé™æ€èµ„æºç­‰ä¸éœ€è¦è®¤è¯çš„è¯·æ±‚
        if (shouldSkipAuthentication(requestURI)) {
            logger.debug("è·³è¿‡è®¤è¯æ£€æŸ¥: {}", requestURI);
            return true;
        }
        
        // ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ID
        String userId = getUserIdFromHeader(request);
        
        if (!StringUtils.hasText(userId)) {
            logger.warn("è¯·æ±‚ç¼ºå°‘ç”¨æˆ·ID: {} {}", method, requestURI);
            sendUnauthorizedResponse(response, "ç¼ºå°‘ç”¨æˆ·ID");
            return false;
        }
        
        // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        try {
            UsersDO user = usersDAO.getByUserId(userId);
            if (user == null || user.getDeleted() == 1) {
                logger.warn("ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²åˆ é™¤: userId={}", userId);
                sendUnauthorizedResponse(response, "ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²åˆ é™¤");
                return false;
            }
            
            // åˆ›å»ºç”¨æˆ·ä¼šè¯å¹¶è®¾ç½®åˆ°ThreadLocal
            UserSession userSession = createUserSession(user);
            UserSessionHolder.setUserSession(userSession);
            
            logger.debug("ç”¨æˆ·è®¤è¯æˆåŠŸ: userId={}, username={}", userId, user.getUsername());
            return true;
            
        } catch (Exception e) {
            logger.error("ç”¨æˆ·è®¤è¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: userId={}, error={}", userId, e.getMessage(), e);
            sendUnauthorizedResponse(response, "è®¤è¯å¤±è´¥");
            return false;
        }
    }
    
    /**
     * è¯·æ±‚å®Œæˆåçš„æ¸…ç†æ–¹æ³•
     * æ¸…é™¤ThreadLocalä¸­çš„ç”¨æˆ·ä¼šè¯ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        try {
            // æ¸…é™¤ç”¨æˆ·ä¼šè¯
            UserSessionHolder.clearUserSession();
        } catch (Exception e) {
            logger.error("æ¸…é™¤ç”¨æˆ·ä¼šè¯æ—¶å‘ç”Ÿå¼‚å¸¸", e);
        }
    }
    
    /**
     * ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ID
     */
    private String getUserIdFromHeader(HttpServletRequest request) {
        // ä¼˜å…ˆä»X-User-Idå¤´è·å–
        String userId = request.getHeader(USER_ID_HEADER);
        if (StringUtils.hasText(userId)) {
            return userId.trim();
        }
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä»userIdå¤´è·å–
        userId = request.getHeader(USER_ID_HEADER_ALT);
        if (StringUtils.hasText(userId)) {
            return userId.trim();
        }
        
        return null;
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·ä¼šè¯å¯¹è±¡
     */
    private UserSession createUserSession(UsersDO user) {
        return new UserSession(user.getUserId(), user.getUsername());
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦åº”è¯¥è·³è¿‡è®¤è¯æ£€æŸ¥
     */
    private boolean shouldSkipAuthentication(String requestURI) {
        // å¥åº·æ£€æŸ¥æ¥å£
        if (requestURI.contains("/actuator/")) {
            return true;
        }
        
        // é™æ€èµ„æº
        if (requestURI.contains("/static/") || requestURI.contains("/public/")) {
            return true;
        }
        
        // Swaggeræ–‡æ¡£
        if (requestURI.contains("/swagger") || requestURI.contains("/v3/api-docs")) {
            return true;
        }
        
        // é”™è¯¯é¡µé¢
        if (requestURI.contains("/error")) {
            return true;
        }
        
        return false;
    }
    
    /**
     * å‘é€æœªæˆæƒå“åº”
     */
    private void sendUnauthorizedResponse(HttpServletResponse response, String message) throws IOException {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");
        
        String jsonResponse = String.format(
            "{\"code\":%d,\"message\":\"%s\",\"data\":null,\"timestamp\":%d}",
            HttpServletResponse.SC_UNAUTHORIZED,
            message,
            System.currentTimeMillis()
        );
        
        response.getWriter().write(jsonResponse);
        response.getWriter().flush();
    }
}
```

#### Webé…ç½®ç±»

```java
/**
 * Webé…ç½®ç±»
 * é…ç½®Spring MVCç›¸å…³è®¾ç½®ï¼ŒåŒ…æ‹¬æ‹¦æˆªå™¨æ³¨å†Œå’Œé¡µé¢é‡å®šå‘
 * 
 * @author Mxy
 */
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Resource
    private UserAuthInterceptor userAuthInterceptor;
    
    @Resource(name = "ttlTaskExecutor")
    private ThreadPoolTaskExecutor ttlTaskExecutor;
    
    /**
     * æ·»åŠ æ‹¦æˆªå™¨é…ç½®
     * æ³¨å†Œç”¨æˆ·è®¤è¯æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªæ‰€æœ‰APIè¯·æ±‚è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯
     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(userAuthInterceptor)
                // æ‹¦æˆªæ‰€æœ‰APIè¯·æ±‚
                .addPathPatterns("/api/**")
                // æ’é™¤ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
                .excludePathPatterns(
                    // å¥åº·æ£€æŸ¥
                    "/actuator/**",
                    // Swaggeræ–‡æ¡£
                    "/swagger-ui/**",
                    "/swagger-ui.html",
                    "/v3/api-docs/**",
                    "/swagger-resources/**",
                    "/webjars/**",
                    // é™æ€èµ„æº
                    "/static/**",
                    "/public/**",
                    "/favicon.ico",
                    // é”™è¯¯é¡µé¢
                    "/error/**",
                    // ç”¨æˆ·è®¤è¯ç›¸å…³æ¥å£ï¼ˆæ— éœ€ç™»å½•ï¼‰
                    "/api/v1/user/register",
                    "/api/v1/user/login",
                    "/api/v1/user/check-username"
                )
                // è®¾ç½®æ‹¦æˆªå™¨é¡ºåºï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
                .order(1);
    }
    
    /**
     * é…ç½®CORSè·¨åŸŸæ”¯æŒ
     * å…è®¸å‰ç«¯é¡µé¢è·¨åŸŸè®¿é—®APIæ¥å£
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                // å…è®¸æ‰€æœ‰æ¥æºï¼ˆå¼€å‘ç¯å¢ƒï¼‰
                .allowedOriginPatterns("*")
                // å…è®¸çš„HTTPæ–¹æ³•
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                // å…è®¸çš„è¯·æ±‚å¤´
                .allowedHeaders("*")
                // å…è®¸å‘é€Cookie
                .allowCredentials(true)
                // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
                .maxAge(3600);
    }
    
    /**
     * é…ç½®å¼‚æ­¥æ”¯æŒ
     * ä½¿ç”¨è‡ªå®šä¹‰çš„TTLä»»åŠ¡æ‰§è¡Œå™¨æ›¿ä»£é»˜è®¤çš„SimpleAsyncTaskExecutor
     * è§£å†³ç”Ÿäº§ç¯å¢ƒä¸‹çš„å¼‚æ­¥å¤„ç†æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¿æŒç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’
     */
    @Override
    public void configureAsyncSupport(AsyncSupportConfigurer configurer) {
        // è®¾ç½®å¼‚æ­¥è¯·æ±‚çš„ä»»åŠ¡æ‰§è¡Œå™¨
        configurer.setTaskExecutor(ttlTaskExecutor);
        // è®¾ç½®å¼‚æ­¥è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆ30ç§’ï¼‰
        configurer.setDefaultTimeout(30000);
    }
}
```

#### TTLçº¿ç¨‹æ± é…ç½®

```java
/**
 * TTLï¼ˆTransmittableThreadLocalï¼‰é…ç½®ç±»
 * é…ç½®æ”¯æŒTTLçš„çº¿ç¨‹æ± ï¼Œç¡®ä¿å¼‚æ­¥ä»»åŠ¡ä¸­èƒ½å¤Ÿæ­£ç¡®ä¼ é€’ç”¨æˆ·ä¸Šä¸‹æ–‡
 * 
 * @author Mxy
 */
@Configuration
public class TtlConfig {
    
    private static final Logger logger = LoggerFactory.getLogger(TtlConfig.class);
    
    /**
     * é…ç½®æ”¯æŒTTLçš„å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨
     * ä½¿ç”¨TTLè£…é¥°å™¨åŒ…è£…çº¿ç¨‹æ± ï¼Œç¡®ä¿å¼‚æ­¥ä»»åŠ¡ä¸­èƒ½å¤Ÿè·å–åˆ°ä¸»çº¿ç¨‹çš„ç”¨æˆ·ä¸Šä¸‹æ–‡
     */
    @Bean("ttlTaskExecutor")
    public ThreadPoolTaskExecutor ttlTaskExecutor() {
        logger.info("åˆå§‹åŒ–æ”¯æŒTTLçš„çº¿ç¨‹æ± æ‰§è¡Œå™¨");
        
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setCorePoolSize(5);
        // æœ€å¤§çº¿ç¨‹æ•°
        executor.setMaxPoolSize(20);
        // é˜Ÿåˆ—å®¹é‡
        executor.setQueueCapacity(100);
        // çº¿ç¨‹åå‰ç¼€
        executor.setThreadNamePrefix("ttl-async-");
        // æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸåå†å…³é—­çº¿ç¨‹æ± 
        executor.setWaitForTasksToCompleteOnShutdown(true);
        // ç­‰å¾…æ—¶é—´
        executor.setAwaitTerminationSeconds(60);
        
        executor.initialize();
        
        // ä½¿ç”¨TTLè£…é¥°å™¨åŒ…è£…çº¿ç¨‹æ± ï¼Œæ”¯æŒä¸Šä¸‹æ–‡ä¼ é€’
        return executor;
    }
    
    /**
     * é…ç½®æ”¯æŒTTLçš„è°ƒåº¦ä»»åŠ¡æ‰§è¡Œå™¨
     * ç”¨äºå®šæ—¶ä»»åŠ¡ç­‰åœºæ™¯
     */
    @Bean("ttlScheduledExecutor")
    public Executor ttlScheduledExecutor() {
        logger.info("åˆå§‹åŒ–æ”¯æŒTTLçš„è°ƒåº¦çº¿ç¨‹æ± æ‰§è¡Œå™¨");
        
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(50);
        executor.setThreadNamePrefix("ttl-scheduled-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.setAwaitTerminationSeconds(30);
        
        executor.initialize();
        
        return TtlExecutors.getTtlExecutor(executor.getThreadPoolExecutor());
    }
}
```

#### ç”¨æˆ·ä¸Šä¸‹æ–‡å·¥å…·ç±»

```java
/**
 * ç”¨æˆ·ä¸Šä¸‹æ–‡å·¥å…·ç±»
 * æä¾›ä¾¿æ·çš„æ–¹æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
 * 
 * @author Mxy
 */
public class UserContextUtil {
    
    /**
     * è·å–å½“å‰ç”¨æˆ·ID
     * 
     * @return å½“å‰ç”¨æˆ·ID
     */
    public static String getCurrentUserId() {
        return UserSessionHolder.getCurrentUserId();
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·å
     * 
     * @return å½“å‰ç”¨æˆ·å
     */
    public static String getCurrentUsername() {
        return UserSessionHolder.getCurrentUsername();
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·ä¼šè¯
     * 
     * @return å½“å‰ç”¨æˆ·ä¼šè¯
     */
    public static UserSession getCurrentUserSession() {
        return UserSessionHolder.getUserSession();
    }
}
```

### 3. æ§åˆ¶å™¨å±‚å®ç°

#### æ™ºèƒ½å¯¹è¯æ§åˆ¶å™¨

```java
/**
 * æ™ºèƒ½å¯¹è¯æ§åˆ¶å™¨
 * æä¾›æ™ºèƒ½é—®ç­”ã€æµå¼å¯¹è¯ã€å¯¹è¯å†å²æŸ¥è¯¢ç­‰REST APIæ¥å£
 *
 * @author Mxy
 */
@Tag(name = "æ™ºèƒ½å¯¹è¯ç®¡ç†", description = "æä¾›æ™ºèƒ½é—®ç­”ã€æµå¼å¯¹è¯ã€å¯¹è¯å†å²æŸ¥è¯¢ç­‰åŠŸèƒ½")
@RestController
@RequestMapping("/api/v1/chat")
public class ChatController {

    private static final Logger logger = LoggerFactory.getLogger(ChatController.class);

    @Resource
    private ChatService chatService;

    /**
     * æ™ºèƒ½é—®ç­”ï¼ˆé˜»å¡å¼ï¼‰
     * åŸºäºçŸ¥è¯†åº“è¿›è¡Œé—®ç­”ï¼Œè¿”å›å®Œæ•´çš„å›ç­”ç»“æœ
     *
     * @param request é—®ç­”è¯·æ±‚å‚æ•°
     * @return é—®ç­”ç»“æœ
     */
    @Operation(summary = "æ™ºèƒ½é—®ç­”", description = "åŸºäºçŸ¥è¯†åº“è¿›è¡Œæ™ºèƒ½é—®ç­”ï¼Œè¿”å›å®Œæ•´çš„å›ç­”ç»“æœ")
    @PostMapping("/ask")
    public ApiResult<String> askQuestion(
            @Parameter(description = "é—®ç­”è¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody ChatAskRequest request) {
        try {
            String currentUsername = UserContextUtil.getCurrentUsername();
            logger.info("æ¥æ”¶æ™ºèƒ½é—®ç­”è¯·æ±‚: sessionId={}, currentUsername={}, question={}",
                    request.getSessionId(), currentUsername, request.getQuestion());

            // è½¬æ¢ä¸ºDTO
            ChatAskDTO dto = new ChatAskDTO();
            BeanUtils.copyProperties(request, dto);

            String result = chatService.askQuestion(dto);
            return ApiResult.success("é—®ç­”æˆåŠŸ", result);
        } catch (Exception e) {
            logger.error("æ™ºèƒ½é—®ç­”å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("æ™ºèƒ½é—®ç­”å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æµå¼æ™ºèƒ½é—®ç­”
     * åŸºäºçŸ¥è¯†åº“è¿›è¡Œé—®ç­”ï¼Œä»¥æµçš„å½¢å¼è¿”å›å›ç­”å†…å®¹
     *
     * @param request æµå¼é—®ç­”è¯·æ±‚å‚æ•°
     * @return æµå¼å›ç­”å†…å®¹
     */
    @Operation(summary = "æµå¼æ™ºèƒ½é—®ç­”", description = "åŸºäºçŸ¥è¯†åº“è¿›è¡Œæ™ºèƒ½é—®ç­”ï¼Œä»¥æµçš„å½¢å¼è¿”å›å›ç­”å†…å®¹")
    @PostMapping(value = "/stream", produces = MediaType.TEXT_PLAIN_VALUE)
    public Flux<String> askQuestionStream(
            @Parameter(description = "æµå¼é—®ç­”è¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody ChatAskRequest request) {
        try {
            String currentUsername = UserContextUtil.getCurrentUsername();
            logger.info("æ¥æ”¶æµå¼æ™ºèƒ½é—®ç­”è¯·æ±‚: sessionId={}, currentUsername={}, question={}",
                    request.getSessionId(), currentUsername, request.getQuestion());

            // è½¬æ¢ä¸ºDTO
            ChatAskDTO dto = new ChatAskDTO();
            BeanUtils.copyProperties(request, dto);

            return chatService.askQuestionStream(dto);
        } catch (Exception e) {
            logger.error("æµå¼æ™ºèƒ½é—®ç­”å¤±è´¥: {}", e.getMessage(), e);
            return Flux.error(new RuntimeException("æµå¼æ™ºèƒ½é—®ç­”å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * è·å–å¯¹è¯å†å²
     * åˆ†é¡µæŸ¥è¯¢æŒ‡å®šä¼šè¯çš„å¯¹è¯å†å²è®°å½•
     *
     * @return åˆ†é¡µçš„å¯¹è¯å†å²
     */
    @Operation(summary = "è·å–å¯¹è¯å†å²", description = "åˆ†é¡µæŸ¥è¯¢æŒ‡å®šä¼šè¯çš„å¯¹è¯å†å²è®°å½•")
    @PostMapping("/getChatHistory")
    public ApiResult<PageResult<ChatMessageVO>> getChatHistory(@RequestBody ChatMessagePageRequest chatMessagePageRequest) {
        try {
            logger.info("è·å–å¯¹è¯å†å²: sessionId={}, pageNum={}, pageSize={}",
                    chatMessagePageRequest.getSessionId(),
                    chatMessagePageRequest.getPageNum(), chatMessagePageRequest.getPageSize());
            ChatMessagePageRequestDTO chatMessagePageRequestDTO = new ChatMessagePageRequestDTO();
            BeanUtils.copyProperties(chatMessagePageRequest, chatMessagePageRequestDTO);

            PageResult<ChatMessageVO> result = chatService.getChatHistory(chatMessagePageRequestDTO);
            return ApiResult.success(result);
        } catch (Exception e) {
            logger.error("è·å–å¯¹è¯å†å²å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("è·å–å¯¹è¯å†å²å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * ç”¨æˆ·åé¦ˆ
     * ç”¨æˆ·å¯¹AIå›ç­”è¿›è¡Œè¯„åˆ†å’Œåé¦ˆ
     *
     * @param request åé¦ˆè¯·æ±‚å‚æ•°
     * @return åé¦ˆå¤„ç†ç»“æœ
     */
    @Operation(summary = "ç”¨æˆ·åé¦ˆ", description = "ç”¨æˆ·å¯¹AIå›ç­”è¿›è¡Œè¯„åˆ†å’Œåé¦ˆ")
    @PostMapping("/feedback")
    public ApiResult<Void> submitFeedback(
            @Parameter(description = "åé¦ˆè¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody ChatFeedbackRequest request) {
        try {
            logger.info("æ¥æ”¶ç”¨æˆ·åé¦ˆ: messageId={}, rating={}",
                    request.getMessageId(), request.getRating());

            // è½¬æ¢ä¸ºDTO
            ChatFeedbackDTO dto = new ChatFeedbackDTO();
            BeanUtils.copyProperties(request, dto);

            chatService.submitFeedback(dto);
            return ApiResult.success();
        } catch (Exception e) {
            logger.error("ç”¨æˆ·åé¦ˆå¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("ç”¨æˆ·åé¦ˆå¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * è‡ªåŠ¨ç”Ÿæˆä¼šè¯æ ‡é¢˜
     * æ ¹æ®ä¼šè¯çš„èŠå¤©è®°å½•è‡ªåŠ¨ç”Ÿæˆåˆé€‚çš„æ ‡é¢˜
     *
     * @param sessionId ä¼šè¯ID
     * @return ç”Ÿæˆçš„æ ‡é¢˜
     */
    @Operation(summary = "è‡ªåŠ¨ç”Ÿæˆä¼šè¯æ ‡é¢˜", description = "æ ¹æ®ä¼šè¯çš„èŠå¤©è®°å½•è‡ªåŠ¨ç”Ÿæˆåˆé€‚çš„æ ‡é¢˜")
    @PostMapping("/generateTitle/{sessionId}")
    public ApiResult<String> generateSessionTitle(
            @Parameter(description = "ä¼šè¯ID", required = true)
            @PathVariable Long sessionId) {
        try {
            logger.info("ç”Ÿæˆä¼šè¯æ ‡é¢˜: sessionId={}", sessionId);
            
            String title = chatService.generateSessionTitle(sessionId);
            return ApiResult.success("æ ‡é¢˜ç”ŸæˆæˆåŠŸ", title);
        } catch (Exception e) {
            logger.error("ç”Ÿæˆä¼šè¯æ ‡é¢˜å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("ç”Ÿæˆä¼šè¯æ ‡é¢˜å¤±è´¥: " + e.getMessage());
        }
    }
}
```

#### èŠå¤©ä¼šè¯ç®¡ç†æ§åˆ¶å™¨

```java
/**
 * èŠå¤©ä¼šè¯ç®¡ç†æ§åˆ¶å™¨
 * æä¾›ä¼šè¯çš„åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ç­‰REST APIæ¥å£
 *
 * @author Mxy
 */
@Tag(name = "èŠå¤©ä¼šè¯ç®¡ç†", description = "æä¾›èŠå¤©ä¼šè¯çš„åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ç­‰åŠŸèƒ½")
@RestController
@RequestMapping("/api/v1/chat/sessions")
public class ChatSessionController {

    private static final Logger logger = LoggerFactory.getLogger(ChatSessionController.class);

    @Resource
    private ChatSessionService chatSessionService;

    /**
     * åˆ›å»ºæ–°çš„èŠå¤©ä¼šè¯
     *
     * @param request åˆ›å»ºä¼šè¯è¯·æ±‚å‚æ•°
     * @return åˆ›å»ºçš„ä¼šè¯ä¿¡æ¯
     */
    @Operation(summary = "åˆ›å»ºèŠå¤©ä¼šè¯", description = "åˆ›å»ºä¸€ä¸ªæ–°çš„èŠå¤©ä¼šè¯")
    @PostMapping("/create")
    public ApiResult<Long> createSession(
            @Parameter(description = "åˆ›å»ºä¼šè¯è¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody CreateSessionRequest request) {
        try {
            // ä»ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
            String currentUserId = UserContextUtil.getCurrentUserId();
            logger.info("æ¥æ”¶åˆ›å»ºä¼šè¯è¯·æ±‚: userId={}, title={}", currentUserId, request.getTitle());

            // è½¬æ¢ä¸ºDTO
            CreateSessionDTO dto = new CreateSessionDTO();
            BeanUtils.copyProperties(request, dto);
            Long sessionId = chatSessionService.createSession(dto);
            return ApiResult.success(sessionId);
        } catch (Exception e) {
            logger.error("åˆ›å»ºä¼šè¯å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("åˆ›å»ºä¼šè¯å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æ ¹æ®ä¼šè¯IDè·å–ä¼šè¯è¯¦æƒ…
     *
     * @param sessionId ä¼šè¯ID
     * @return ä¼šè¯è¯¦æƒ…
     */
    @Operation(summary = "è·å–ä¼šè¯è¯¦æƒ…", description = "æ ¹æ®ä¼šè¯IDè·å–ä¼šè¯çš„è¯¦ç»†ä¿¡æ¯")
    @GetMapping("/detail/{sessionId}")
    public ApiResult<SessionVO> getSessionById(
            @Parameter(description = "ä¼šè¯ID", required = true) @PathVariable Long sessionId) {
        try {
            // ä»ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
            String currentUserId = UserContextUtil.getCurrentUserId();
            logger.info("è·å–ä¼šè¯è¯¦æƒ…: sessionId={}, userId={}", sessionId, currentUserId);
            SessionVO sessionVO = chatSessionService.getSessionById(sessionId);
            return ApiResult.success(sessionVO);
        } catch (Exception e) {
            logger.error("è·å–ä¼šè¯è¯¦æƒ…å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("è·å–ä¼šè¯è¯¦æƒ…å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨
     *
     * @param request æŸ¥è¯¢è¯·æ±‚å‚æ•°
     * @return åˆ†é¡µæŸ¥è¯¢ç»“æœ
     */
    @Operation(summary = "æŸ¥è¯¢ä¼šè¯åˆ—è¡¨", description = "åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨ï¼Œæ”¯æŒå…³é”®è¯æœç´¢å’ŒçŠ¶æ€è¿‡æ»¤")
    @PostMapping("/list")
    public ApiResult<PageResult<SessionVO>> getSessionList(
            @Parameter(description = "æŸ¥è¯¢è¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody SessionQueryRequest request) {
        try {
            // ä»ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
            String currentUserId = UserContextUtil.getCurrentUserId();
            logger.info("æŸ¥è¯¢ä¼šè¯åˆ—è¡¨:pageNum={}, pageSize={}", request.getPageNum(), request.getPageSize());

            // è½¬æ¢ä¸ºDTO
            SessionQueryDTO dto = new SessionQueryDTO();
            BeanUtils.copyProperties(request, dto);
            PageResult<SessionVO> result = chatSessionService.getSessionList(dto);
            return ApiResult.success(result);
        } catch (Exception e) {
            logger.error("æŸ¥è¯¢ä¼šè¯åˆ—è¡¨å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("æŸ¥è¯¢ä¼šè¯åˆ—è¡¨å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æ›´æ–°ä¼šè¯æ ‡é¢˜
     *
     * @param request æ›´æ–°æ ‡é¢˜è¯·æ±‚å‚æ•°ï¼ˆåŒ…å«sessionIdã€userIdå’Œtitleï¼‰
     * @return æ›´æ–°åçš„ä¼šè¯ä¿¡æ¯
     */
    @Operation(summary = "æ›´æ–°ä¼šè¯æ ‡é¢˜", description = "æ›´æ–°æŒ‡å®šä¼šè¯çš„æ ‡é¢˜")
    @PostMapping("/update-title")
    public ApiResult<SessionVO> updateSessionTitle(
            @Parameter(description = "æ›´æ–°æ ‡é¢˜è¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody UpdateSessionTitleRequest request) {
        try {
            // ä»ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
            String currentUserId = UserContextUtil.getCurrentUserId();
            logger.info("æ›´æ–°ä¼šè¯æ ‡é¢˜: sessionId={}, userId={}, title={}",
                    request.getSessionId(), currentUserId, request.getTitle());

            // è½¬æ¢ä¸ºDTO
            UpdateSessionTitleDTO dto = new UpdateSessionTitleDTO();
            BeanUtils.copyProperties(request, dto);

            chatSessionService.updateSessionTitle(dto);
            return ApiResult.success();
        } catch (Exception e) {
            logger.error("æ›´æ–°ä¼šè¯æ ‡é¢˜å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("æ›´æ–°ä¼šè¯æ ‡é¢˜å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * åˆ é™¤ä¼šè¯
     *
     * @param request åˆ é™¤ä¼šè¯è¯·æ±‚å‚æ•°
     * @return åˆ é™¤ç»“æœ
     */
    @Operation(summary = "åˆ é™¤ä¼šè¯", description = "åˆ é™¤æŒ‡å®šçš„ä¼šè¯")
    @PostMapping("/delete")
    public ApiResult<Void> deleteSession(
            @Parameter(description = "åˆ é™¤ä¼šè¯è¯·æ±‚å‚æ•°", required = true)
            @Valid @RequestBody DeleteSessionRequest request) {
        try {
            // ä»ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
            String currentUserId = UserContextUtil.getCurrentUserId();
            logger.info("åˆ é™¤ä¼šè¯: sessionId={}, userId={}", request.getSessionId(), currentUserId);

            // è½¬æ¢ä¸ºDTO
            DeleteSessionDTO dto = new DeleteSessionDTO();
            BeanUtils.copyProperties(request, dto);
            dto.setUserId(currentUserId);

            chatSessionService.deleteSession(dto);
            return ApiResult.success();
        } catch (Exception e) {
            logger.error("åˆ é™¤ä¼šè¯å¤±è´¥: {}", e.getMessage(), e);
            return ApiResult.error("åˆ é™¤ä¼šè¯å¤±è´¥: " + e.getMessage());
        }
    }
}
```

### 4. å‘é‡æ•°æ®åº“é›†æˆ

#### å¤šæ•°æ®æºé…ç½®

```java
/**
 * å¤šæ•°æ®æºé…ç½®ç±»
 * é…ç½®MySQLä¸šåŠ¡æ•°æ®åº“å’ŒPostgreSQLå‘é‡æ•°æ®åº“
 * 
 * @author Mxy
 */
@Configuration
@Slf4j
public class MultiDataSourceConfig {
    
    /**
     * é…ç½®å‘é‡æ•°æ®åº“æ•°æ®æºå±æ€§
     * ä½¿ç”¨@ConfigurationPropertiesæ³¨è§£ç»‘å®šé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§
     */
    @Bean(name = "pgVectorDataSourceProperties")
    @ConfigurationProperties("spring.datasource.pgvector")
    public DataSourceProperties pgVectorDataSourceProperties() {
        return new DataSourceProperties();
    }
    
    /**
     * åˆå§‹åŒ–å‘é‡æ•°æ®åº“æ•°æ®æº
     * ä½¿ç”¨HikariDataSourceç¡®ä¿å±æ€§æ­£ç¡®ç»‘å®š
     */
    @Bean("pgVectorDataSource")
    public DataSource vectorDataSource(@Qualifier("pgVectorDataSourceProperties") DataSourceProperties dataSourceProperties) {
        log.info("åˆå§‹åŒ–å‘é‡æ•°æ®åº“");
        return dataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();
    }

    /**
     * é…ç½®å‘é‡æ•°æ®åº“JdbcTemplate
     * ç”¨äºæ‰§è¡Œå‘é‡ç›¸å…³çš„SQLæ“ä½œ
     */
    @Bean
    @Primary
    public JdbcTemplate pgVectorJdbcTemplate(@Qualifier("pgVectorDataSource") DataSource dataSource) {
        log.info("åˆå§‹åŒ–JdbcTemplate");
        return new JdbcTemplate(dataSource);
    }

    /**
     * é…ç½®MySQLä¸šåŠ¡æ•°æ®åº“æ•°æ®æºå±æ€§
     */
    @Primary
    @Bean(name = "mysqlDataSourceProperties")
    @ConfigurationProperties("spring.datasource.mysql")
    public DataSourceProperties mysqlDataSourceProperties() {
        return new DataSourceProperties();
    }

    /**
     * åˆå§‹åŒ–MySQLä¸šåŠ¡æ•°æ®æº
     * ä½¿ç”¨HikariDataSourceç¡®ä¿å±æ€§æ­£ç¡®ç»‘å®š
     */
    @Bean("mysqlDataSource")
    @Primary
    public DataSource masterDataSource(@Qualifier("mysqlDataSourceProperties")
                                           DataSourceProperties dataSourceProperties) {
        log.info("åˆå§‹åŒ–ä¸»æ•°æ®æº");
        return dataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();
    }

    /**
     * é…ç½®MyBatis SqlSessionFactory
     * ç”¨äºMySQLæ•°æ®åº“çš„ORMæ“ä½œ
     */
    @Bean("sqlSessionFactory")
    @Primary
    public SqlSessionFactory sqlSessionFactory(@Qualifier("mysqlDataSource") DataSource mysqlDataSource) throws Exception {
        MybatisSqlSessionFactoryBean sessionFactory = new MybatisSqlSessionFactoryBean();
        sessionFactory.setDataSource(mysqlDataSource);
        // è®¾ç½®mapperæ–‡ä»¶ä½ç½®
        sessionFactory.setMapperLocations(
                new PathMatchingResourcePatternResolver().getResources("classpath*:mapper/**/*Mapper*.xml"));
        // è®¾ç½®MyBatis Plusæ’ä»¶
        sessionFactory.setPlugins(mybatisPlusInterceptor());
        log.info("åˆå§‹åŒ–SqlSessionFactory");
        return sessionFactory.getObject();
    }

    /**
     * é…ç½®äº‹åŠ¡ç®¡ç†å™¨
     * ç®¡ç†MySQLæ•°æ®åº“çš„äº‹åŠ¡
     */
    @Bean("transactionManager")
    @Primary
    public PlatformTransactionManager transactionManager(@Qualifier("mysqlDataSource") DataSource mysqlDataSource) {
        log.info("åˆå§‹åŒ–äº‹åŠ¡ç®¡ç†å™¨");
        return new DataSourceTransactionManager(mysqlDataSource);
    }

    /**
     * é…ç½®MyBatis Plusæ’ä»¶
     * åŒ…æ‹¬åˆ†é¡µæ’ä»¶ç­‰åŠŸèƒ½å¢å¼º
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();

        // åˆ†é¡µæ’ä»¶
        PaginationInnerInterceptor paginationInnerInterceptor = new PaginationInnerInterceptor();
        paginationInnerInterceptor.setMaxLimit(1000L); // è®¾ç½®æœ€å¤§åˆ†é¡µé™åˆ¶
        interceptor.addInnerInterceptor(paginationInnerInterceptor);

        log.info("åˆå§‹åŒ–MyBatis Plusæ‹¦æˆªå™¨");
        return interceptor;
    }
}
```

**è‡ªå®šä¹‰èŠå¤©è®°å¿†ä»“åº“ï¼š**
```java
@Component
public class CustomChatMemoryRepository implements ChatMemoryRepository {

    private final ChatSessionsMapper chatSessionsMapper;
    private final ChatMessagesMapper chatMessagesMapper;

    public CustomChatMemoryRepository(ChatSessionsMapper chatSessionsMapper, ChatMessagesMapper chatMessagesMapper) {
        this.chatSessionsMapper = chatSessionsMapper;
        this.chatMessagesMapper = chatMessagesMapper;
    }

    @Override
    public List<Message> getMessages(String conversationId) {
        List<ChatMessagesDO> messageDOs = chatMessagesMapper.findBySessionId(conversationId);
        return messageDOs.stream()
                .map(this::convertToMessage)
                .collect(Collectors.toList());
    }

    @Override
    public void saveMessages(String conversationId, List<Message> messages) {
        for (Message message : messages) {
            ChatMessagesDO messageDO = convertToChatMessagesDO(conversationId, message);
            chatMessagesMapper.insert(messageDO);
        }
    }

    @Override
    public void deleteMessages(String conversationId) {
        chatMessagesMapper.deleteBySessionId(conversationId);
    }
}
```

#### æ–‡æ¡£å¤„ç†æœåŠ¡

```java
@Override
public void loadFile(MultipartFile file) {
    try {
        String originalFilename = file.getOriginalFilename();
        if (originalFilename == null) {
            throw new IllegalArgumentException("æ–‡ä»¶åä¸èƒ½ä¸ºç©º");
        }

        logger.info("å¼€å§‹å¤„ç†æ–‡ä»¶: {}", originalFilename);

        List<Document> documents;
        String fileExtension = getFileExtension(originalFilename).toLowerCase();

        if ("pdf".equals(fileExtension)) {
            // PDFæ–‡ä»¶å¤„ç†
            PdfDocumentReader pdfReader = new PdfDocumentReader(file.getResource());
            documents = pdfReader.get();
        } else {
            // å…¶ä»–æ–‡ä»¶ç±»å‹ä½¿ç”¨Tikaå¤„ç†
            TikaDocumentReader tikaReader = new TikaDocumentReader(file.getResource());
            documents = tikaReader.get();
        }

        if (documents.isEmpty()) {
            throw new RuntimeException("æœªèƒ½ä»æ–‡ä»¶ä¸­æå–åˆ°ä»»ä½•å†…å®¹");
        }

        // æ–‡æœ¬åˆ†å—å¤„ç†
        TextSplitter textSplitter = new TokenTextSplitter(500, 100, 5, 10000, true);
        List<Document> splitDocuments = textSplitter.apply(documents);

        // æ·»åŠ å…ƒæ•°æ®
        for (Document doc : splitDocuments) {
            doc.getMetadata().put("source", originalFilename);
            doc.getMetadata().put("upload_time", System.currentTimeMillis());
        }

        // å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
        vectorStore.add(splitDocuments);
        logger.info("æ–‡ä»¶ {} å¤„ç†å®Œæˆï¼Œå…±ç”Ÿæˆ {} ä¸ªæ–‡æ¡£å—", originalFilename, splitDocuments.size());

    } catch (Exception e) {
        logger.error("æ–‡ä»¶å¤„ç†å¤±è´¥: {}", file.getOriginalFilename(), e);
        throw new RuntimeException("æ–‡ä»¶å¤„ç†å¤±è´¥: " + e.getMessage(), e);
    }
}

private String getFileExtension(String filename) {
    int lastDotIndex = filename.lastIndexOf('.');
    return lastDotIndex > 0 ? filename.substring(lastDotIndex + 1) : "";
}
```



## ğŸ¨ å‰ç«¯å®ç°è¯¦è§£

### 1. é¡¹ç›®ç»“æ„

å‰ç«¯é‡‡ç”¨åŸç”ŸHTML+CSS+JavaScriptå®ç°ï¼Œæ— æ¡†æ¶ä¾èµ–ï¼Œç»“æ„æ¸…æ™°ç®€æ´ï¼š

```
src/main/resources/static/
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ common.css      # å…¬å…±æ ·å¼
â”‚   â”œâ”€â”€ login.css       # ç™»å½•é¡µæ ·å¼
â”‚   â”œâ”€â”€ chat.css        # èŠå¤©é¡µæ ·å¼
â”‚   â””â”€â”€ knowledge.css   # çŸ¥è¯†åº“ç®¡ç†æ ·å¼
â”œâ”€â”€ js/
â”‚   â””â”€â”€ api.js          # APIå®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ login.html          # ç™»å½•æ³¨å†Œé¡µé¢
â”œâ”€â”€ chat.html           # æ™ºèƒ½èŠå¤©é¡µé¢
â””â”€â”€ knowledge.html      # çŸ¥è¯†åº“ç®¡ç†é¡µé¢
```

### 2. APIå®¢æˆ·ç«¯å°è£…

**api.js - ç»Ÿä¸€çš„HTTPè¯·æ±‚å¤„ç†ï¼š**

```javascript
class ApiClient {
    constructor() {
        this.baseURL = '';
        this.token = localStorage.getItem('token');
        this.userId = localStorage.getItem('userId');
    }

    // é€šç”¨è¯·æ±‚æ–¹æ³•
    async request(url, options = {}) {
        const config = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        // æ·»åŠ è®¤è¯å¤´
        if (this.token) {
            config.headers['Authorization'] = `Bearer ${this.token}`;
        }
        if (this.userId) {
            config.headers['X-User-Id'] = this.userId;
        }

        try {
            const response = await fetch(this.baseURL + url, config);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            }
            return await response.text();
        } catch (error) {
            console.error('APIè¯·æ±‚å¤±è´¥:', error);
            throw error;
        }
    }

    // GETè¯·æ±‚
    async get(url, params = {}) {
        const queryString = new URLSearchParams(params).toString();
        const fullUrl = queryString ? `${url}?${queryString}` : url;
        return this.request(fullUrl, { method: 'GET' });
    }

    // POSTè¯·æ±‚
    async post(url, data = {}) {
        return this.request(url, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }

    // æ–‡ä»¶ä¸Šä¼ 
    async uploadFile(url, file, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            const formData = new FormData();
            formData.append('file', file);

            // è®¾ç½®è®¤è¯å¤´
            if (this.token) {
                xhr.setRequestHeader('Authorization', `Bearer ${this.token}`);
            }
            if (this.userId) {
                xhr.setRequestHeader('X-User-Id', this.userId);
            }

            // ä¸Šä¼ è¿›åº¦å›è°ƒ
            if (onProgress) {
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        onProgress(percentComplete);
                    }
                };
            }

            xhr.onload = () => {
                if (xhr.status === 200) {
                    resolve(xhr.responseText);
                } else {
                    reject(new Error(`ä¸Šä¼ å¤±è´¥: ${xhr.statusText}`));
                }
            };

            xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'));
            xhr.open('POST', this.baseURL + url);
            xhr.send(formData);
        });
    }
}

// å…¨å±€APIå®¢æˆ·ç«¯å®ä¾‹
const api = new ApiClient();
```

### 3. æ™ºèƒ½èŠå¤©ç•Œé¢å®ç°

**chat.html - æ ¸å¿ƒèŠå¤©åŠŸèƒ½ï¼š**

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½çŸ¥è¯†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <i class="fas fa-robot"></i>
                <h3>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½çŸ¥è¯†åŠ©æ‰‹ï¼</h3>
                <p>æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”é—®é¢˜ï¼Œåˆ†ææ–‡æ¡£å†…å®¹ã€‚è¯·è¾“å…¥æ‚¨çš„é—®é¢˜å¼€å§‹å¯¹è¯ã€‚</p>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <textarea id="messageInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1"></textarea>
                <button id="sendButton" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        class ChatApp {
            constructor() {
                this.messagesContainer = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.isLoading = false;
                
                this.initEventListeners();
                this.autoResizeTextarea();
            }

            initEventListeners() {
                // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                // å›è½¦å‘é€æ¶ˆæ¯
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isLoading) return;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                this.addMessage(message, 'user');
                this.messageInput.value = '';
                this.isLoading = true;
                this.updateSendButton();

                // æ·»åŠ åŠ è½½æ¶ˆæ¯
                const loadingId = this.addLoadingMessage();

                try {
                    // è°ƒç”¨èŠå¤©API
                    const response = await api.post('/api/chat', {
                        message: message,
                        useKnowledgeBase: true
                    });

                    // ç§»é™¤åŠ è½½æ¶ˆæ¯
                    this.removeMessage(loadingId);
                    
                    // æ·»åŠ AIå›å¤
                    this.addMessage(response.content || response, 'assistant');
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    this.removeMessage(loadingId);
                    this.addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'assistant', true);
                } finally {
                    this.isLoading = false;
                    this.updateSendButton();
                }
            }

            addMessage(content, role, isError = false) {
                const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message ${isError ? 'error' : ''}`;
                messageDiv.id = messageId;

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = role === 'user' ? 
                    '<i class="fas fa-user"></i>' : 
                    '<i class="fas fa-robot"></i>';

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                if (role === 'assistant' && !isError) {
                    // ä½¿ç”¨marked.jsæ¸²æŸ“Markdown
                    messageContent.innerHTML = marked.parse(content);
                    // ä»£ç é«˜äº®
                    messageContent.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });
                } else {
                    messageContent.textContent = content;
                }

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                this.messagesContainer.appendChild(messageDiv);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                this.scrollToBottom();
                
                return messageId;
            }

            addLoadingMessage() {
                const messageId = 'loading-' + Date.now();
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant-message loading';
                messageDiv.id = messageId;

                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;

                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                return messageId;
            }

            removeMessage(messageId) {
                const message = document.getElementById(messageId);
                if (message) {
                    message.remove();
                }
            }

            updateSendButton() {
                this.sendButton.disabled = this.isLoading;
                this.sendButton.innerHTML = this.isLoading ? 
                    '<i class="fas fa-spinner fa-spin"></i>' : 
                    '<i class="fas fa-paper-plane"></i>';
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            autoResizeTextarea() {
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
                });
            }
        }

        // åˆå§‹åŒ–èŠå¤©åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new ChatApp();
        });
    </script>
</body>
</html>
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### PostgreSQLï¼ˆå‘é‡æ•°æ®ï¼‰

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- å‘é‡å­˜å‚¨è¡¨ï¼ˆSpring AIé»˜è®¤è¡¨ç»“æ„ï¼‰
CREATE TABLE vector_store (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content TEXT NOT NULL,
    metadata JSON,
    embedding vector(1536)
);

-- åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
CREATE INDEX vector_store_embedding_idx ON vector_store 
USING hnsw (embedding vector_cosine_ops);

-- åˆ›å»ºå†…å®¹å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX vector_store_content_idx ON vector_store 
USING gin (to_tsvector('english', content));
```

### MySQLï¼ˆä¸šåŠ¡æ•°æ®ï¼‰

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id VARCHAR(50) PRIMARY KEY COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(100) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ',
    email VARCHAR(255) COMMENT 'é‚®ç®±',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    is_deleted TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';

-- èŠå¤©ä¼šè¯è¡¨
CREATE TABLE chat_sessions (
    id VARCHAR(50) PRIMARY KEY COMMENT 'ä¼šè¯ID',
    user_id VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·ID',
    title VARCHAR(255) NOT NULL COMMENT 'ä¼šè¯æ ‡é¢˜',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    is_deleted TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='èŠå¤©ä¼šè¯è¡¨';

-- èŠå¤©æ¶ˆæ¯è¡¨
CREATE TABLE chat_messages (
    id VARCHAR(50) PRIMARY KEY COMMENT 'æ¶ˆæ¯ID',
    session_id VARCHAR(50) NOT NULL COMMENT 'ä¼šè¯ID',
    user_id VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·ID',
    content TEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
    message_type VARCHAR(20) NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹ï¼šUSER/ASSISTANT',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='èŠå¤©æ¶ˆæ¯è¡¨';

-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'é…ç½®ID',
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'é…ç½®é”®',
    config_value TEXT COMMENT 'é…ç½®å€¼',
    description VARCHAR(255) COMMENT 'é…ç½®æè¿°',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç³»ç»Ÿé…ç½®è¡¨';
```

## ğŸš€ éƒ¨ç½²ä¸è¿ç»´

### ç”Ÿäº§ç¯å¢ƒé…ç½®

**application-prod.yamlï¼š**
```yaml
spring:
  datasource:
    pg-vector:
      driver-class-name: org.postgresql.Driver
      url: jdbc:postgresql://${PG_HOST:localhost}:${PG_PORT:5432}/${PG_DATABASE:rag_vector}
      username: ${PG_USERNAME:postgres}
      password: ${PG_PASSWORD:password}
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5
        idle-timeout: 300000
        max-lifetime: 1200000
        connection-timeout: 20000
    mysql:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://${MYSQL_HOST:localhost}:${MYSQL_PORT:3306}/${MYSQL_DATABASE:rag_business}?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      username: ${MYSQL_USERNAME:root}
      password: ${MYSQL_PASSWORD:password}
      hikari:
        maximum-pool-size: 30
        minimum-idle: 10
        idle-timeout: 300000
        max-lifetime: 1200000
        connection-timeout: 20000
  ai:
    dashscope:
      api-key: ${DASHSCOPE_API_KEY}
      chat:
        options:
          model: ${DASHSCOPE_MODEL:qwen-plus}
          temperature: ${DASHSCOPE_TEMPERATURE:0.7}

logging:
  level:
    com.mxy.rag: INFO
    org.springframework.ai: INFO
  file:
    name: logs/mxy-rag-server.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /
  tomcat:
    max-threads: 200
    min-spare-threads: 10
```

### Dockeréƒ¨ç½²

**Dockerfileï¼š**
```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

# å¤åˆ¶jaræ–‡ä»¶
COPY target/mxy-rag-server-*.jar app.jar

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p logs

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-Xms512m", "-Xmx2g", "-jar", "app.jar", "--spring.profiles.active=prod"]
```

### Docker Composeé…ç½®

**docker-compose.ymlï¼š**

```yaml
version: '3.8'
services:
  app:
    build: ..
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_DATABASE=rag_vector
      - PG_USERNAME=postgres
      - PG_PASSWORD=postgres123
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=rag_business
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=mysql123
    depends_on:
      - postgres
      - mysql
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg16
    environment:
      - POSTGRES_DB=rag_vector
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts/init-postgres.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=mysql123
      - MYSQL_DATABASE=rag_business
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-scripts/init-mysql.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

volumes:
  postgres_data:
  mysql_data:
```

## ğŸ“ æ€»ç»“

æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†åŸºäºSpring AIå’Œé˜¿é‡Œäº‘DashScopeæ„å»ºRAGç³»ç»Ÿçš„å®Œæ•´å®ç°æ–¹æ¡ˆã€‚ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§
- **å¤šæ¨¡å‹æ”¯æŒ**ï¼šé›†æˆé˜¿é‡Œäº‘DashScopeï¼Œæ”¯æŒé€šä¹‰åƒé—®ç³»åˆ—æ¨¡å‹
- **å‘é‡æ£€ç´¢**ï¼šåŸºäºpgvectorçš„é«˜æ•ˆå‘é‡å­˜å‚¨å’Œæ£€ç´¢
- **å¤šæ•°æ®æº**ï¼šPostgreSQLå­˜å‚¨å‘é‡æ•°æ®ï¼ŒMySQLå­˜å‚¨ä¸šåŠ¡æ•°æ®
- **èŠå¤©è®°å¿†**ï¼šæ”¯æŒå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡è®°å¿†
- **æ–‡æ¡£å¤„ç†**ï¼šæ”¯æŒPDFã€Wordç­‰å¤šç§æ–‡æ¡£æ ¼å¼
- **ç”¨æˆ·è®¤è¯**ï¼šå®Œæ•´çš„ç”¨æˆ·ç®¡ç†å’Œä¼šè¯ç®¡ç†

### ğŸ› ï¸ æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**ï¼šSpring Boot 3.x + Spring AI Alibaba
- **AIæ¨¡å‹**ï¼šé˜¿é‡Œäº‘DashScopeï¼ˆé€šä¹‰åƒé—®ï¼‰
- **å‘é‡æ•°æ®åº“**ï¼šPostgreSQL + pgvector
- **ä¸šåŠ¡æ•°æ®åº“**ï¼šMySQL 8.0
- **ORMæ¡†æ¶**ï¼šMyBatis Plus
- **æ–‡æ¡£å¤„ç†**ï¼šApache Tika + Spring AI Document Readers

### ğŸš€ éƒ¨ç½²æ–¹å¼
- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker + Docker Compose
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ”¯æŒç¯å¢ƒå˜é‡é…ç½®
- **æ—¥å¿—ç®¡ç†**ï¼šç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- **ç›‘æ§è¿ç»´**ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

é€šè¿‡æœ¬æ–¹æ¡ˆï¼Œå¯ä»¥å¿«é€Ÿæ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜å¼‚çš„ä¼ä¸šçº§RAGç³»ç»Ÿï¼Œä¸ºçŸ¥è¯†ç®¡ç†å’Œæ™ºèƒ½é—®ç­”æä¾›å¼ºæœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚


**é¡¹ç›®åœ°å€**ï¼š[https://github.com/Matthew-Miao/mxy-rag-server](https://github.com/Matthew-Miao/mxy-rag-server)

æ¬¢è¿Starå’ŒForkï¼Œä¸€èµ·æ¢è®¨AIåº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µï¼
*å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹èµã€æ”¶è—å¹¶å…³æ³¨ï¼Œæˆ‘ä¼šæŒç»­åˆ†äº«æ›´å¤šAIå¼€å‘å®æˆ˜ç»éªŒï¼*