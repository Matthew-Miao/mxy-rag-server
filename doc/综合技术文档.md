# 智能知识助手系统 - 综合技术文档

## 📋 文档概述

本文档整合了智能知识助手系统的完整技术设计方案，包括系统架构、核心功能、数据库设计、用户认证、开发规划等技术要点。该系统是一个基于RAG（检索增强生成）技术的智能对话平台，支持文档知识库管理和智能问答功能。

**文档版本**：v1.0  
**最后更新**：2025年  
**目标读者**：开发团队、技术架构师、产品经理

---

## 🏗️ 系统架构设计

### 整体架构

系统采用前后端分离的微服务架构，包含以下核心层次：

**前端层 (Frontend)**
- Vue 3 + TypeScript + Element Plus + WebSocket
- 聊天界面、文档管理、会话管理、用户设置

**后端层 (Backend)**
- Spring Boot + Spring AI + MyBatis + WebSocket
- REST API、WebSocket服务、业务逻辑、数据访问

**数据层 (Data)**
- PostgreSQL + pgvector (向量数据库)
- MySQL (业务数据库)
- Redis (缓存层)

**AI服务层 (AI Services)**
- 阿里云通义千问 API
- 文本生成、向量化、语义理解

### 技术架构特点

**混合数据访问策略**：
- PostgreSQL + pgvector：存储文档向量和向量检索
- MySQL：存储业务数据（用户、会话、消息等）
- Redis：缓存热点数据和会话状态

**数据源分离策略**：
1. PostgreSQL + pgvector (向量数据库)：专门用于存储文档向量和执行向量相似度搜索，由Spring AI框架直接管理和使用，配置为非主数据源，通过JdbcTemplate访问
2. MySQL (业务数据库)：存储用户信息、会话记录、消息历史等业务数据，使用MyBatis Plus进行ORM映射，配置为主数据源，支持事务管理

---

## 🛠️ 技术选型

### 后端技术栈

| 技术组件 | 版本 | 选择理由 | 主要功能 |
|----------|------|----------|----------|
| **Spring Boot** | 3.4.5 | 成熟稳定、生态丰富 | 应用框架 |
| **Spring AI** | 1.0.0 | 官方AI集成框架 | AI服务集成 |
| **MyBatis-Plus** | 3.5.5 | 灵活的SQL控制 | 数据访问层 |
| **PostgreSQL** | 14+ | 支持向量扩展 | 向量数据库 |
| **pgvector** | 0.5+ | 向量相似度搜索 | 向量存储 |
| **MySQL** | 8.0+ | 成熟稳定 | 业务数据存储 |
| **HikariCP** | - | 高性能连接池 | 数据库连接池 |

### 前端技术栈

| 技术组件 | 版本 | 选择理由 | 主要功能 |
|----------|------|----------|----------|
| **Vue 3** | 3.3+ | 现代化框架 | 前端框架 |
| **TypeScript** | 5.0+ | 类型安全 | 开发语言 |
| **Element Plus** | 2.4+ | 丰富的UI组件 | UI组件库 |
| **Vite** | 4.0+ | 快速构建 | 构建工具 |
| **Pinia** | 2.1+ | 状态管理 | 状态管理 |
| **Axios** | 1.6+ | HTTP客户端 | API调用 |

### AI服务选型

**阿里云通义千问**：
- 对话模型使用`qwen-plus-latest`，提供优秀的中文理解和生成能力
- 嵌入模型使用`text-embedding-v3`，向量维度为1024维
- API接入方式：通过阿里云DashScope兼容OpenAI格式的API接口
- 兼容性：使用OpenAI兼容的API格式，便于后续切换其他模型

---

## 🗄️ 数据库设计

### 数据库架构

**PostgreSQL向量数据库**：
- 数据库名：mxy_rag_vector_db
- 主要功能：存储文档向量，支持向量相似度搜索
- 扩展支持：vector、uuid-ossp、pg_trgm、btree_gin等
- 向量维度：最大支持2048维

**MySQL业务数据库**：
- 数据库名：mxy_rag_db
- 字符集：utf8mb4
- 主要表结构：

#### 用户表 (users)
- 主键：id (自增)
- 用户标识：user_id (唯一)
- 基本信息：username, password
- 审计字段：deleted, gmt_create, gmt_modified, creator, modifier

#### 聊天会话表 (chat_sessions)
- 主键：id (自增)
- 会话信息：title, description
- 审计字段：deleted, gmt_create, gmt_modified, creator, modifier

#### 聊天消息表 (chat_messages)
- 主键：id (自增)
- 关联字段：session_id, conversation_id
- 消息内容：message_type, content
- 评价字段：rating (1-5分)
- 审计字段：deleted, gmt_create, gmt_modified, creator, modifier
- 索引：session_id, conversation_id, message_type, rating

**消息类型说明**：
- USER：用户输入消息
- ASSISTANT：AI助手回复消息
- SYSTEM：系统提示消息
- TOOL：工具调用消息

---

## 🎯 核心业务功能

### 智能对话系统

**业务需求**：用户通过自然语言与AI进行问答对话

**技术实现要求**：
- 支持WebSocket实时通信，实现流式响应
- 集成Spring AI框架调用LLM API（阿里云通义千问）
- 实现上下文记忆机制，支持多轮对话
- 响应时间要求：< 3秒
- 支持中英文问答

**核心流程**：
1. 保存用户消息
2. 检索相关知识
3. 构建提示词
4. 调用AI生成回复（流式）
5. 实时通过WebSocket发送给前端
6. 保存完整回复

### 会话管理系统

**业务需求**：管理用户的对话会话生命周期

**技术实现要求**：
- 会话CRUD操作
- 自动会话命名（基于首个问题）
- 会话搜索功能
- 用户数据隔离
- 单用户最多100个活跃会话

**核心功能**：
- 创建新会话
- 获取会话详情和列表
- 更新会话标题和描述
- 会话归档和删除
- 会话恢复
- 用户会话统计

### 知识库管理

**业务需求**：文档上传、处理、存储和检索

**技术实现要求**：
- 支持多种文档格式：PDF、Word、TXT、MD
- 文档内容提取和分块处理
- 向量化存储（使用pgvector）
- 文件大小限制：50MB
- 用户存储空间：1GB

**处理流程**：
1. 文件上传 → 格式验证 → 内容提取
2. 文本分块 → 向量化 → 存储到向量数据库
3. 元数据存储 → 索引建立 → 状态更新

---

## 👤 用户拦截层设计

### 核心组件

1. **UserSession** - 用户会话信息类：存储用户会话相关信息，包括userId、username、usersDO、sessionCreateTime、lastAccessTime、ipAddress、userAgent等字段

2. **UserSessionHolder** - 用户会话持有者：使用ThreadLocal管理用户会话信息，确保线程安全，提供设置、获取、清除用户会话的方法

3. **UserAuthInterceptor** - 用户认证拦截器：拦截所有API请求，验证用户身份并设置用户会话

4. **WebConfig** - Web配置类：注册用户认证拦截器到Spring MVC配置

5. **UserContextUtil** - 用户上下文工具类：提供便捷的方法来获取当前用户信息和执行用户相关操作

### 拦截流程

**preHandle（请求前验证）**：
- 检查是否需要跳过认证（健康检查、静态资源等）
- 从请求头获取用户ID（支持 `X-User-Id` 和 `userId` 两种头）
- 验证用户是否存在且未删除
- 创建UserSession并存储到ThreadLocal

**postHandle（请求后处理）**：
- 更新用户最后访问时间

**afterCompletion（请求完成后清理）**：
- 清除ThreadLocal中的用户会话，防止内存泄漏

### 安全考虑

**线程安全**：
- 使用ThreadLocal确保用户会话信息的线程安全
- 在请求完成后自动清理ThreadLocal，防止内存泄漏

**用户验证**：
- 每次请求都会验证用户是否存在且未删除
- 支持软删除用户的过滤

**IP地址记录**：
- 记录用户的真实IP地址，支持代理和负载均衡环境
- 支持多种IP头的解析（X-Forwarded-For、X-Real-IP等）

---

## 🤖 Spring AI集成设计

### ChatMemoryRepository重构

**改造目标**：将CustomChatMemoryRepository改造为完全符合Spring AI标准的ChatMemoryRepository实现

**主要改造内容**：

1. **参数验证增强**：使用Spring的Assert工具类进行严格的参数验证，与Spring AI标准保持一致的错误消息

2. **saveAll方法事务性改造**：添加@Transactional注解确保事务性，实现增量保存策略而非"先删除再插入"

3. **消息时间戳序列机制**：为每条消息分配递增的时间戳，确保严格的顺序，与Spring AI的AtomicLong instantSeq机制保持一致

4. **TOOL消息类型支持**：完整支持Spring AI的所有消息类型，ToolResponseMessage按标准实现为空内容

5. **消息排序优化**：数据库层面直接按时间升序查询，消除不必要的内存排序操作

### 重构解决方案

**增量保存策略**：
- 获取现有消息数量
- 只保存新增的消息
- 避免重复保存已存在的消息

**消息窗口管理**：
- 清理超出窗口大小的旧消息（保留系统消息）
- 分离系统消息和其他消息
- 使用软删除机制

**优势总结**：
- 性能提升：避免了不必要的删除和重新插入操作
- 数据完整性：保持了消息的连续性，系统消息得到特殊保护
- Spring AI兼容性：完全符合MessageWindowChatMemory的设计理念
- 事务安全：所有数据库操作都在事务中执行

---

## 📊 性能优化方案

### 缓存策略

**Redis缓存配置**：
- 缓存会话信息，TTL为30分钟
- 缓存用户最近的消息
- 向量检索结果缓存，TTL为15分钟

**向量检索优化**：
- 查询缓存机制
- 相似度阈值设置为0.7
- 批量操作优化

### 数据库优化

**索引设计**：
- 会话表：user_id、created_at、status索引
- 消息表：session_id、user_id、created_at索引
- 文档表：user_id、status索引
- 向量索引：使用ivfflat算法的向量余弦相似度索引

**分页查询优化**：
- 使用游标分页避免深度分页问题
- 优化的分页查询SQL

---

## 🔒 安全实现方案

### 认证授权

**JWT认证配置**：
- 无状态会话管理
- JWT令牌验证过滤器
- 用户详情服务集成

**数据权限控制**：
- 检查用户是否有权限访问会话
- 检查用户是否有权限访问文档
- 数据权限切面实现

### 数据安全

**敏感数据加密**：
- AES/GCM/NoPadding加密算法
- Base64编码存储
- 密钥管理机制

**访问控制**：
- 基于角色的权限控制
- 接口级别的权限验证
- 数据级别的权限隔离

---

## 🚀 分阶段开发规划

### 第一阶段：基础数据层搭建（1-2周）
**目标**：建立完整的数据访问层，支持MySQL业务数据和PostgreSQL向量数据的混合访问
**核心任务**：数据库设计与初始化、实体类设计、数据访问层、MyBatis配置
**交付物**：完整的数据库表结构、所有实体类和Mapper接口、数据访问层单元测试、多数据源配置验证

### 第二阶段：核心业务功能搭建（2-3周）
**目标**：实现智能对话和会话管理的核心功能，建立RAG工作流程
**核心任务**：会话管理功能、智能对话功能、RAG核心流程
**交付物**：完整的会话管理功能（9个会话管理接口）、基础的智能对话能力、RAG检索增强逻辑

### 第三阶段：知识库管理优化（1-2周）
**目标**：完善知识库管理功能，优化现有KnowledgeBaseController
**核心任务**：知识库管理重构、文档处理优化、用户隔离机制
**交付物**：重构后的知识库管理功能、完善的文档处理流程、用户数据隔离机制

### 第四阶段：用户系统与权限管理（1周）
**目标**：建立完整的用户认证和权限管理体系
**核心任务**：用户认证系统、权限控制、安全机制
**交付物**：完整的用户认证系统、权限控制机制、安全防护措施

### 第五阶段：系统优化与监控（1周）
**目标**：完善系统监控、异常处理和性能优化
**核心任务**：系统监控、异常处理、性能优化
**交付物**：系统监控体系、完善的异常处理机制、性能优化方案

### 第六阶段：测试与部署（1周）
**目标**：全面测试系统功能，准备生产环境部署
**核心任务**：测试体系、部署准备、文档完善
**交付物**：完整的测试报告、生产环境部署包、完善的项目文档

**总体时间规划**：7-10周完成完整系统开发和部署

---

## 🎯 关键成功因素

1. **数据层稳固**：确保多数据源配置正确，数据访问层稳定
2. **RAG流程完善**：知识库检索和AI对话的核心逻辑要扎实
3. **用户体验优先**：会话管理和对话交互要流畅自然
4. **安全性保障**：用户数据隔离和权限控制要严格
5. **系统可维护**：代码结构清晰，监控体系完善

---

## 📈 总结

本综合技术文档详细描述了智能知识助手系统的完整技术方案，涵盖了从系统架构设计到具体实现细节的各个方面。系统采用现代化的技术栈，结合RAG技术和Spring AI框架，为用户提供智能化的知识问答服务。

### 核心特性
- **混合数据架构**：业务数据与向量数据分离存储
- **实时流式响应**：基于WebSocket的流式对话
- **高性能检索**：pgvector向量相似度搜索
- **完整的用户体系**：用户认证、权限控制、数据隔离
- **Spring AI集成**：标准化的AI服务集成方案

### 技术优势
- **可扩展性**：模块化设计，易于功能扩展
- **高性能**：多级缓存，数据库优化
- **安全性**：完善的认证授权机制
- **可维护性**：清晰的代码结构和文档

该技术方案为开发团队提供了完整的实施指南，确保项目的高质量交付和稳定运行。